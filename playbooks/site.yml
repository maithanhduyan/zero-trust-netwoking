---
# =============================================================================
# MASTER PLAYBOOK - Deploy toÃ n bá»™ infrastructure
# =============================================================================
# 
# Usage:
#   # Deploy táº¥t cáº£
#   ansible-playbook playbooks/site.yml
#
#   # Chá»‰ Control Plane
#   ansible-playbook playbooks/site.yml --limit control_plane
#
#   # Chá»‰ Worker Nodes
#   ansible-playbook playbooks/site.yml --limit worker_nodes
#
#   # Theo role
#   ansible-playbook playbooks/site.yml --limit db_nodes
#   ansible-playbook playbooks/site.yml --tags "security,wireguard"
#
# =============================================================================

# =============================================================================
# PHASE 1: CONTROL PLANE
# =============================================================================
- name: Setup Control Plane
  hosts: control_plane
  become: yes
  tags: [control_plane, phase1]
  
  pre_tasks:
    - name: Display phase
      debug:
        msg: "ğŸ›ï¸  Phase 1: Setting up Control Plane..."
  
  roles:
    - role: common
      tags: [common, base]
    
    - role: security
      tags: [security, firewall]
    
    - role: wireguard
      vars:
        wg_is_hub: true
      tags: [wireguard, vpn]

# =============================================================================
# PHASE 2: WORKER NODES - Base Setup
# =============================================================================
- name: Setup Worker Nodes Base
  hosts: worker_nodes
  become: yes
  tags: [worker_nodes, phase2]
  
  pre_tasks:
    - name: Display phase
      debug:
        msg: "ğŸ–¥ï¸  Phase 2: Setting up Worker Nodes base..."
  
  roles:
    - role: common
      tags: [common, base]
    
    - role: security
      tags: [security, firewall]
    
    - role: wireguard
      vars:
        wg_is_hub: false
      tags: [wireguard, vpn]
    
    - role: docker
      tags: [docker, container]

# =============================================================================
# PHASE 3: DATABASE NODES
# =============================================================================
- name: Setup Database Nodes
  hosts: db_nodes
  become: yes
  tags: [database, phase3]
  
  pre_tasks:
    - name: Display phase
      debug:
        msg: "ğŸ—„ï¸  Phase 3: Setting up Database Nodes..."
  
  roles:
    - role: postgres-ha
      tags: [postgres, database]

# =============================================================================
# PHASE 4: APPLICATION NODES
# =============================================================================
- name: Setup Application Nodes
  hosts: app_nodes
  become: yes
  tags: [application, phase4]
  
  pre_tasks:
    - name: Display phase
      debug:
        msg: "ğŸš€ Phase 4: Setting up Application Nodes..."
  
  roles:
    - role: odoo-app
      tags: [odoo, application]

# =============================================================================
# PHASE 5: VERIFICATION
# =============================================================================
- name: Verify Cluster Status
  hosts: cluster
  become: yes
  tags: [verify, phase5]
  
  tasks:
    - name: Check WireGuard status
      command: wg show wg0
      register: wg_status
      changed_when: false
      ignore_errors: yes

    - name: Display node status
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Node: {{ inventory_hostname }}
          Role: {{ node_role | default('unknown') }}
          WireGuard IP: {{ wg_address | default('N/A') }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
