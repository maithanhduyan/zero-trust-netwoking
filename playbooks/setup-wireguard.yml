---
# =============================================================================
# WIREGUARD SETUP PLAYBOOK - CÃ i Ä‘áº·t WireGuard trÃªn mÃ¡y hiá»‡n táº¡i
# =============================================================================
#
# Usage:
#   ansible-playbook playbooks/setup-wireguard.yml
#
# Playbook nÃ y sáº½:
#   1. CÃ i Ä‘áº·t WireGuard
#   2. Generate private/public key pair
#   3. Hiá»ƒn thá»‹ public key Ä‘á»ƒ báº¡n thÃªm vÃ o cÃ¡c peers khÃ¡c
#
# =============================================================================

- name: Setup WireGuard on local machine
  hosts: localhost
  connection: local
  become: yes
  
  vars:
    # WireGuard IP cho mÃ¡y nÃ y (hub server)
    wg_address: "10.10.0.1"
    wg_is_hub: true
    wg_port: 51820
    wg_network_prefix: 24
    
    # Danh sÃ¡ch peers (ban Ä‘áº§u trá»‘ng, thÃªm sau)
    wg_peers: []
  
  tasks:
    - name: Display setup information
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              WIREGUARD SETUP - 100% Tá»° CHá»¦                           â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  KhÃ´ng báº¥t ká»³ bÃªn thá»© 3 nÃ o                  â•‘
          â•‘  WireGuard IP: {{ wg_address }}                                             â•‘
          â•‘  Port: {{ wg_port }} (UDP)                                                â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Install WireGuard
      apt:
        name:
          - wireguard
          - wireguard-tools
        state: present
        update_cache: yes

    - name: Enable IP forwarding
      sysctl:
        name: "{{ item }}"
        value: "1"
        sysctl_file: /etc/sysctl.d/99-wireguard.conf
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    - name: Create WireGuard directory
      file:
        path: /etc/wireguard
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Check if private key exists
      stat:
        path: /etc/wireguard/private.key
      register: wg_private_key_file

    - name: Generate WireGuard private key
      shell: wg genkey
      register: wg_genkey
      when: not wg_private_key_file.stat.exists

    - name: Save private key
      copy:
        content: "{{ wg_genkey.stdout }}"
        dest: /etc/wireguard/private.key
        mode: '0600'
        owner: root
        group: root
      when: not wg_private_key_file.stat.exists

    - name: Read private key
      slurp:
        src: /etc/wireguard/private.key
      register: wg_private_key

    - name: Generate and save public key
      shell: echo "{{ wg_private_key.content | b64decode | trim }}" | wg pubkey
      register: wg_pubkey

    - name: Save public key
      copy:
        content: "{{ wg_pubkey.stdout }}"
        dest: /etc/wireguard/public.key
        mode: '0644'
        owner: root
        group: root

    - name: Set key facts
      set_fact:
        wireguard_private_key: "{{ wg_private_key.content | b64decode | trim }}"
        wireguard_public_key: "{{ wg_pubkey.stdout | trim }}"

    - name: Create WireGuard configuration
      copy:
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
        owner: root
        group: root
        content: |
          # =============================================================================
          # WIREGUARD CONFIGURATION - Hub Server
          # =============================================================================
          # Generated by Ansible - {{ ansible_date_time.iso8601 }}
          # =============================================================================
          
          [Interface]
          PrivateKey = {{ wireguard_private_key }}
          Address = {{ wg_address }}/{{ wg_network_prefix }}
          ListenPort = {{ wg_port }}
          
          # NAT Masquerade cho hub server
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE
          
          # =============================================================================
          # PEERS - ThÃªm cÃ¡c node khÃ¡c vÃ o Ä‘Ã¢y
          # =============================================================================
          # VÃ­ dá»¥:
          # [Peer]
          # # db-primary
          # PublicKey = <PUBLIC_KEY_CUA_DB_PRIMARY>
          # AllowedIPs = 10.10.0.10/32
          # PersistentKeepalive = 25
      notify: restart wireguard

    - name: Allow WireGuard port in UFW
      ufw:
        rule: allow
        port: "{{ wg_port }}"
        proto: udp
        comment: "WireGuard VPN"
      ignore_errors: yes

    - name: Enable and start WireGuard
      systemd:
        name: wg-quick@wg0
        enabled: yes
        state: started

    - name: Get WireGuard status
      command: wg show wg0
      register: wg_status
      changed_when: false

    - name: Display SUCCESS and Public Key
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… WIREGUARD ÄÃƒ CÃ€I Äáº¶T THÃ€NH CÃ”NG!                     â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                                      â•‘
          â•‘  ğŸ”‘ PUBLIC KEY (LÆ°u láº¡i Ä‘á»ƒ thÃªm vÃ o cÃ¡c VPS khÃ¡c):                  â•‘
          â•‘  {{ wireguard_public_key }}  â•‘
          â•‘                                                                      â•‘
          â•‘  ğŸŒ ENDPOINT: {{ ansible_default_ipv4.address }}:{{ wg_port }}                              â•‘
          â•‘                                                                      â•‘
          â•‘  ğŸ”’ WIREGUARD IP: {{ wg_address }}                                          â•‘
          â•‘                                                                      â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  BÆ¯á»šC TIáº¾P THEO:                                                     â•‘
          â•‘  1. Cháº¡y playbook nÃ y trÃªn cÃ¡c VPS khÃ¡c                              â•‘
          â•‘  2. Thu tháº­p public key tá»« má»—i VPS                                   â•‘
          â•‘  3. ThÃªm peers vÃ o /etc/wireguard/wg0.conf                          â•‘
          â•‘  4. Restart: systemctl restart wg-quick@wg0                          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          WireGuard Status:
          {{ wg_status.stdout }}

  handlers:
    - name: restart wireguard
      systemd:
        name: wg-quick@wg0
        state: restarted
