---
# =============================================================================
# SETUP WORKER NODE
# =============================================================================
# Thiáº¿t láº­p Worker Node vÃ  káº¿t ná»‘i vÃ o WireGuard mesh
#
# Usage trÃªn node má»›i:
#   ansible-playbook playbooks/setup-worker-node.yml \
#     -e "wg_address=10.10.0.10" \
#     -e "node_name=db-primary"
#
# Hoáº·c Ä‘Æ¡n giáº£n hÆ¡n - dÃ¹ng bootstrap.sh:
#   ./bootstrap.sh 10.10.0.10 db-primary
# =============================================================================

- name: Setup Worker Node
  hosts: localhost
  connection: local
  become: yes
  
  vars:
    # Required - pháº£i truyá»n vÃ o
    # wg_address: "10.10.0.10"
    # node_name: "db-primary"
    
    # Hub configuration (láº¥y tá»« group_vars hoáº·c default)
    wg_hub_endpoint: "{{ lookup('env', 'WG_HUB_ENDPOINT') | default('5.104.82.252', true) }}"
    wg_hub_public_key: "{{ lookup('env', 'WG_HUB_PUBLIC_KEY') | default('9c7Sd43PyenG33LjKho0TKykNCJbqgXwhJHRF0jloEs=', true) }}"
    wg_hub_port: 51820
    wg_network: "10.10.0.0/24"
  
  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - wg_address is defined
          - node_name is defined
        fail_msg: |
          âŒ Missing required variables!
          
          Usage:
            ansible-playbook playbooks/setup-worker-node.yml \
              -e "wg_address=10.10.0.10" \
              -e "node_name=db-primary"
          
          Or use bootstrap.sh:
            ./bootstrap.sh 10.10.0.10 db-primary

    - name: Display Worker Node info
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              ğŸ–¥ï¸  WORKER NODE SETUP                                   â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Node Name: {{ node_name }}
          â•‘  WireGuard IP: {{ wg_address }}
          â•‘  Hub Endpoint: {{ wg_hub_endpoint }}:{{ wg_hub_port }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  tasks:
    # =========================================================================
    # INSTALL WIREGUARD
    # =========================================================================
    - name: Install WireGuard
      apt:
        name:
          - wireguard
          - wireguard-tools
        state: present
        update_cache: yes

    - name: Enable IP forwarding
      sysctl:
        name: "{{ item }}"
        value: "1"
        sysctl_file: /etc/sysctl.d/99-wireguard.conf
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    # =========================================================================
    # GENERATE KEYS
    # =========================================================================
    - name: Create WireGuard directory
      file:
        path: /etc/wireguard
        state: directory
        mode: '0700'

    - name: Check if private key exists
      stat:
        path: /etc/wireguard/private.key
      register: wg_key_exists

    - name: Generate WireGuard keys
      shell: wg genkey | tee /etc/wireguard/private.key | wg pubkey > /etc/wireguard/public.key
      when: not wg_key_exists.stat.exists

    - name: Secure private key
      file:
        path: /etc/wireguard/private.key
        mode: '0600'

    - name: Read keys
      slurp:
        src: "{{ item }}"
      register: wg_keys
      loop:
        - /etc/wireguard/private.key
        - /etc/wireguard/public.key

    - name: Set key facts
      set_fact:
        wg_private_key: "{{ wg_keys.results[0].content | b64decode | trim }}"
        wg_public_key: "{{ wg_keys.results[1].content | b64decode | trim }}"

    # =========================================================================
    # CREATE CONFIG
    # =========================================================================
    - name: Create WireGuard config
      copy:
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
        content: |
          # =============================================================================
          # WORKER NODE: {{ node_name }}
          # =============================================================================
          # Generated: {{ ansible_date_time.iso8601 }}
          # WireGuard IP: {{ wg_address }}
          # =============================================================================
          
          [Interface]
          PrivateKey = {{ wg_private_key }}
          Address = {{ wg_address }}/24
          
          # =============================================================================
          # CONTROL PLANE (Hub)
          # =============================================================================
          [Peer]
          # Control Plane - Hub Server
          PublicKey = {{ wg_hub_public_key }}
          Endpoint = {{ wg_hub_endpoint }}:{{ wg_hub_port }}
          AllowedIPs = {{ wg_network }}
          PersistentKeepalive = 25
      notify: restart wireguard

    # =========================================================================
    # START SERVICE
    # =========================================================================
    - name: Enable and start WireGuard
      systemd:
        name: wg-quick@wg0
        enabled: yes
        state: started

    - name: Wait for WireGuard
      pause:
        seconds: 2

    # =========================================================================
    # VERIFY & OUTPUT
    # =========================================================================
    - name: Get WireGuard status
      command: wg show wg0
      register: wg_status
      changed_when: false

    - name: Test connectivity to Control Plane
      command: ping -c 3 -W 5 10.10.0.1
      register: ping_hub
      ignore_errors: yes
      changed_when: false

    - name: Display SUCCESS
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… WORKER NODE CONFIGURED!                                      â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                                              â•‘
          â•‘  ğŸ“‹ Node: {{ node_name }}
          â•‘  ğŸŒ WireGuard IP: {{ wg_address }}
          â•‘                                                                              â•‘
          â•‘  ğŸ”‘ PUBLIC KEY (copy Ä‘á»ƒ thÃªm vÃ o Control Plane):                             â•‘
          â•‘  {{ wg_public_key }}
          â•‘                                                                              â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ“ CHáº Y TRÃŠN CONTROL PLANE ({{ wg_hub_endpoint }}):                         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                                              â•‘
          â•‘  ./scripts/add-peer-to-hub.sh "{{ node_name }}" \                            â•‘
          â•‘      "{{ wg_public_key }}" \                                                 â•‘
          â•‘      "{{ wg_address }}"                                                      â•‘
          â•‘                                                                              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ”— Control Plane connectivity: {{ 'CONNECTED âœ…' if ping_hub.rc == 0 else 'PENDING â³ (cáº§n thÃªm peer vÃ o Control Plane)' }}

  handlers:
    - name: restart wireguard
      systemd:
        name: wg-quick@wg0
        state: restarted
