---
# =============================================================================
# SETUP CONTROL PLANE
# =============================================================================
# Thiáº¿t láº­p Control Plane (Hub Server) - Cháº¡y Ä‘áº§u tiÃªn
#
# Usage:
#   ansible-playbook playbooks/setup-control-plane.yml
#
# Control Plane responsibilities:
#   - WireGuard Hub (VPN mesh center)
#   - Peer management
#   - Network routing
# =============================================================================

- name: Setup Control Plane
  hosts: control_plane
  become: yes
  
  vars:
    wg_address: "{{ hostvars[inventory_hostname]['wg_address'] | default('10.10.0.1') }}"
  
  pre_tasks:
    - name: Display Control Plane info
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              ğŸ›ï¸  CONTROL PLANE SETUP                                 â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Host: {{ inventory_hostname }}
          â•‘  Public IP: {{ ansible_host }}
          â•‘  WireGuard IP: {{ wg_address }}
          â•‘  Role: {{ node_role | default('control_plane') }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  roles:
    - role: common
      tags: [common, base]
    
    - role: security
      tags: [security, firewall]
    
    - role: wireguard
      vars:
        wg_is_hub: true
      tags: [wireguard, vpn]
  
  post_tasks:
    - name: Get WireGuard status
      command: wg show wg0
      register: wg_status
      changed_when: false
      ignore_errors: yes

    - name: Get public key
      slurp:
        src: /etc/wireguard/public.key
      register: wg_pubkey
      ignore_errors: yes

    - name: Display Control Plane status
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… CONTROL PLANE READY!                                         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                                              â•‘
          â•‘  ğŸ”‘ Hub Public Key:                                                          â•‘
          â•‘  {{ wg_pubkey.content | default('') | b64decode | trim }}
          â•‘                                                                              â•‘
          â•‘  ğŸŒ Hub Endpoint: {{ ansible_host }}:51820                                   â•‘
          â•‘  ğŸ“ WireGuard IP: {{ wg_address }}                                           â•‘
          â•‘                                                                              â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ“‹ Worker nodes sáº½ káº¿t ná»‘i Ä‘áº¿n Control Plane nÃ y                            â•‘
          â•‘     Cháº¡y trÃªn worker node:                                                   â•‘
          â•‘     ./bootstrap.sh <wg_ip> <node_name>                                       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          {{ wg_status.stdout | default('WireGuard not running') }}
