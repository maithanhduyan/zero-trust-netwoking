---
# =============================================================================
# ADD WIREGUARD PEER - ThÃªm VPS má»›i vÃ o WireGuard mesh
# =============================================================================
#
# Usage:
#   # TrÃªn VPS má»›i (peer):
#   ansible-playbook playbooks/add-wireguard-peer.yml \
#     -e "wg_address=10.10.0.10" \
#     -e "wg_peer_name=db-primary" \
#     -e "wg_hub_endpoint=5.104.82.252" \
#     -e "wg_hub_public_key=9c7Sd43PyenG33LjKho0TKykNCJbqgXwhJHRF0jloEs="
#
# =============================================================================

- name: Setup WireGuard Peer (Client Node)
  hosts: localhost
  connection: local
  become: yes
  
  vars:
    # Báº¯t buá»™c pháº£i truyá»n vÃ o:
    # wg_address: "10.10.0.10"           # IP WireGuard cá»§a node nÃ y
    # wg_peer_name: "db-primary"         # TÃªn node
    # wg_hub_endpoint: "5.104.82.252"    # Public IP cá»§a hub server
    # wg_hub_public_key: "xxx"           # Public key cá»§a hub server
    
    wg_port: 51820
    wg_network_prefix: 24
    wg_persistent_keepalive: 25
    wg_hub_allowed_ips: "10.10.0.0/24"   # Cho phÃ©p access toÃ n bá»™ WireGuard network
  
  tasks:
    - name: Validate required variables
      assert:
        that:
          - wg_address is defined
          - wg_peer_name is defined
          - wg_hub_endpoint is defined
          - wg_hub_public_key is defined
        fail_msg: |
          Missing required variables! Usage:
          ansible-playbook playbooks/add-wireguard-peer.yml \
            -e "wg_address=10.10.0.10" \
            -e "wg_peer_name=db-primary" \
            -e "wg_hub_endpoint=5.104.82.252" \
            -e "wg_hub_public_key=YOUR_HUB_PUBLIC_KEY"

    - name: Display setup information
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              WIREGUARD PEER SETUP                                    â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Node Name:     {{ wg_peer_name }}
          â•‘  WireGuard IP:  {{ wg_address }}
          â•‘  Hub Endpoint:  {{ wg_hub_endpoint }}:{{ wg_port }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Install WireGuard
      apt:
        name:
          - wireguard
          - wireguard-tools
        state: present
        update_cache: yes

    - name: Enable IP forwarding
      sysctl:
        name: "{{ item }}"
        value: "1"
        sysctl_file: /etc/sysctl.d/99-wireguard.conf
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    - name: Create WireGuard directory
      file:
        path: /etc/wireguard
        state: directory
        mode: '0700'

    - name: Check if private key exists
      stat:
        path: /etc/wireguard/private.key
      register: wg_private_key_file

    - name: Generate WireGuard private key
      shell: wg genkey
      register: wg_genkey
      when: not wg_private_key_file.stat.exists

    - name: Save private key
      copy:
        content: "{{ wg_genkey.stdout }}"
        dest: /etc/wireguard/private.key
        mode: '0600'
      when: not wg_private_key_file.stat.exists

    - name: Read private key
      slurp:
        src: /etc/wireguard/private.key
      register: wg_private_key

    - name: Generate public key
      shell: echo "{{ wg_private_key.content | b64decode | trim }}" | wg pubkey
      register: wg_pubkey

    - name: Save public key
      copy:
        content: "{{ wg_pubkey.stdout }}"
        dest: /etc/wireguard/public.key
        mode: '0644'

    - name: Set key facts
      set_fact:
        wireguard_private_key: "{{ wg_private_key.content | b64decode | trim }}"
        wireguard_public_key: "{{ wg_pubkey.stdout | trim }}"

    - name: Create WireGuard peer configuration
      copy:
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
        content: |
          # =============================================================================
          # WIREGUARD CONFIGURATION - {{ wg_peer_name }}
          # =============================================================================
          # Generated by Ansible - {{ ansible_date_time.iso8601 }}
          # =============================================================================
          
          [Interface]
          PrivateKey = {{ wireguard_private_key }}
          Address = {{ wg_address }}/{{ wg_network_prefix }}
          
          # KhÃ´ng cáº§n ListenPort cho peer (chá»‰ hub cáº§n)
          # Náº¿u peer nÃ y cÅ©ng cáº§n nháº­n káº¿t ná»‘i tá»« peers khÃ¡c, uncomment:
          # ListenPort = {{ wg_port }}
          
          # =============================================================================
          # HUB SERVER
          # =============================================================================
          [Peer]
          # Hub Server
          PublicKey = {{ wg_hub_public_key }}
          Endpoint = {{ wg_hub_endpoint }}:{{ wg_port }}
          AllowedIPs = {{ wg_hub_allowed_ips }}
          PersistentKeepalive = {{ wg_persistent_keepalive }}
      notify: restart wireguard

    - name: Enable and start WireGuard
      systemd:
        name: wg-quick@wg0
        enabled: yes
        state: started

    - name: Wait for WireGuard to start
      pause:
        seconds: 2

    - name: Get WireGuard status
      command: wg show wg0
      register: wg_status
      changed_when: false

    - name: Test connectivity to hub
      command: ping -c 3 10.10.0.1
      register: ping_result
      ignore_errors: yes
      changed_when: false

    - name: Display SUCCESS and instructions
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… WIREGUARD PEER ÄÃƒ Cáº¤U HÃŒNH THÃ€NH CÃ”NG!                       â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                                              â•‘
          â•‘  ðŸ”‘ PUBLIC KEY Cá»¦A NODE NÃ€Y (Copy Ä‘á»ƒ thÃªm vÃ o Hub):                          â•‘
          â•‘  {{ wireguard_public_key }}                                                  â•‘
          â•‘                                                                              â•‘
          â•‘  ðŸŒ WIREGUARD IP: {{ wg_address }}                                           â•‘
          â•‘                                                                              â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  âš ï¸  BÆ¯á»šC TIáº¾P THEO - CHáº Y TRÃŠN HUB SERVER ({{ wg_hub_endpoint }}):          â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                                              â•‘
          â•‘  1. SSH vÃ o hub server:                                                      â•‘
          â•‘     ssh root@{{ wg_hub_endpoint }}                                           â•‘
          â•‘                                                                              â•‘
          â•‘  2. ThÃªm peer vÃ o WireGuard config:                                          â•‘
          â•‘     cat >> /etc/wireguard/wg0.conf << 'EOF'                                  â•‘
          â•‘                                                                              â•‘
          â•‘     [Peer]                                                                   â•‘
          â•‘     # {{ wg_peer_name }}                                                     â•‘
          â•‘     PublicKey = {{ wireguard_public_key }}                                   â•‘
          â•‘     AllowedIPs = {{ wg_address }}/32                                         â•‘
          â•‘     EOF                                                                      â•‘
          â•‘                                                                              â•‘
          â•‘  3. Reload WireGuard (khÃ´ng cáº§n restart):                                    â•‘
          â•‘     wg syncconf wg0 <(wg-quick strip wg0)                                    â•‘
          â•‘                                                                              â•‘
          â•‘  4. Verify káº¿t ná»‘i tá»« hub:                                                   â•‘
          â•‘     ping {{ wg_address }}                                                    â•‘
          â•‘                                                                              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          WireGuard Status:
          {{ wg_status.stdout }}
          
          Ping to Hub (10.10.0.1): {{ 'SUCCESS âœ…' if ping_result.rc == 0 else 'FAILED âŒ (Cáº§n thÃªm peer vÃ o hub trÆ°á»›c)' }}

  handlers:
    - name: restart wireguard
      systemd:
        name: wg-quick@wg0
        state: restarted
