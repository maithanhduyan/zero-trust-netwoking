# =============================================================================
# WIREGUARD CONFIGURATION - {{ inventory_hostname }}
# =============================================================================
# Generated by Ansible - Do not edit manually
# =============================================================================

[Interface]
# Private key của node này
PrivateKey = {{ wireguard_private_key }}

# WireGuard IP trong mạng VPN
Address = {{ wg_address }}/{{ wg_network_prefix | default('24') }}

# Port lắng nghe (chỉ cần trên hub hoặc node có public IP)
ListenPort = {{ wg_port | default('51820') }}

# DNS server (optional)
{% if wg_dns is defined %}
DNS = {{ wg_dns }}
{% endif %}

# Post-up scripts (optional - cho routing)
{% if wg_is_hub | default(false) %}
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE
{% endif %}

# =============================================================================
# PEERS - Các node khác trong mạng
# =============================================================================
{% for peer in wg_peers | default([]) %}
{% if peer.name != inventory_hostname %}

[Peer]
# {{ peer.name }}
PublicKey = {{ peer.public_key }}
{% if peer.endpoint is defined %}
Endpoint = {{ peer.endpoint }}:{{ peer.port | default('51820') }}
{% endif %}
AllowedIPs = {{ peer.allowed_ips | default(peer.address + '/32') }}
{% if peer.persistent_keepalive | default(false) %}
PersistentKeepalive = {{ peer.persistent_keepalive }}
{% endif %}
{% endif %}
{% endfor %}
