---
# =============================================================================
# SECURITY ROLE - Tasks (UFW + Fail2ban)
# =============================================================================

- name: Install UFW firewall
  apt:
    name: ufw
    state: present

- name: Set UFW default incoming policy (DENY)
  ufw:
    direction: incoming
    policy: "{{ ufw_default_incoming }}"
  notify: reload ufw

- name: Set UFW default outgoing policy (ALLOW)
  ufw:
    direction: outgoing
    policy: "{{ ufw_default_outgoing }}"
  notify: reload ufw

- name: Allow WireGuard interface
  ufw:
    rule: allow
    interface: wg0
    direction: in
    comment: "Allow all traffic from WireGuard VPN"
  notify: reload ufw
  ignore_errors: yes

- name: Configure allowed ports
  ufw:
    rule: allow
    port: "{{ item.port | string }}"
    proto: "{{ item.proto }}"
    from_ip: "{{ item.from }}"
    comment: "Allow {{ item.port }}/{{ item.proto }} from {{ item.from }}"
  loop: "{{ ufw_allowed_ports }}"
  notify: reload ufw

- name: Enable UFW
  ufw:
    state: enabled
    logging: "{{ ufw_logging }}"

- name: Install fail2ban
  apt:
    name: fail2ban
    state: present

- name: Configure fail2ban for SSH
  copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      ignoreip = 127.0.0.1/8 10.10.0.0/24
      
      [sshd]
      enabled = true
      port = {{ ssh_port }}
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 86400
    mode: '0644'
  notify: restart fail2ban

- name: Enable fail2ban service
  systemd:
    name: fail2ban
    enabled: yes
    state: started
