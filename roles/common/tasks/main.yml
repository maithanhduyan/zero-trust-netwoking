---
# =============================================================================
# COMMON ROLE - Tasks
# =============================================================================

- name: Set timezone
  timezone:
    name: "{{ timezone }}"
  tags: [timezone]

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: [packages]

- name: Install common packages
  apt:
    name: "{{ common_packages }}"
    state: present
  tags: [packages]

- name: Configure automatic security updates
  apt:
    name: unattended-upgrades
    state: present
  tags: [security]

- name: Enable unattended-upgrades
  copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
    mode: '0644'
  tags: [security]

- name: Configure sysctl for security and networking
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-zero-trust.conf
    reload: yes
  loop:
    - { name: 'net.ipv4.ip_forward', value: '1' }
    - { name: 'net.ipv4.conf.all.rp_filter', value: '1' }
    - { name: 'net.ipv4.conf.default.rp_filter', value: '1' }
    - { name: 'net.ipv4.icmp_echo_ignore_broadcasts', value: '1' }
    - { name: 'net.ipv4.conf.all.accept_source_route', value: '0' }
    - { name: 'net.ipv4.conf.all.send_redirects', value: '0' }
    - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
    - { name: 'net.ipv4.conf.all.log_martians', value: '1' }
    - { name: 'net.ipv6.conf.all.disable_ipv6', value: '0' }
  tags: [security, sysctl]
