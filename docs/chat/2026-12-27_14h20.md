**User:**
Thiết kế chức năng control-plane `register` để ansible playbook và wireguard tạo `Overlay IP` cho client
**AI:**
Không, workflow không hoạt động như vậy. Để tôi giải thích rõ luồng thực tế:

Research registration workflow

Read [](file:///home/zero-trust-netwoking/control-plane/api/v1/agent.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-netwoking/agent/agent.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-netwoking/agent/client.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-netwoking/docs/WORKFLOW.md#1-1), lines 1 to 200

Read [](file:///home/zero-trust-netwoking/docs/WORKFLOW.md#200-200), lines 200 to 324

Read [](file:///home/zero-trust-netwoking/agent/agent.py#200-200), lines 200 to 304

## Workflow Thực Tế

**Không!** API **không gọi Ansible** để cấu hình WireGuard. Đây là workflow đúng:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         DEPLOYMENT TIME (1 lần)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Ansible                                                               │
│      │                                                                  │
│      ├──▶ Cài WireGuard + Agent lên VPS                                │
│      ├──▶ Generate keypair (wg genkey)                                  │
│      └──▶ Start zt-agent.service                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         RUNTIME (liên tục)                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Agent (daemon)           Control Plane                               │
│      │                          │                                       │
│      ├──POST /register ────────▶│ Lưu DB, cấp Overlay IP               │
│      │◀────────────────────────┤ Trả về: 10.0.0.2, hub_pubkey          │
│      │                          │                                       │
│      ├── Tự build wg0.conf      │                                       │
│      ├── wg-quick up wg0        │                                       │
│      │                          │                                       │
│   (Loop mỗi 60s)                │                                       │
│      ├──GET /config ───────────▶│ Policy Engine tính peers + ACL       │
│      │◀────────────────────────┤ Trả về: peers[], acl_rules[]          │
│      │                          │                                       │
│      ├── wg set wg0 peer ...    │ (Agent tự apply)                     │
│      └── iptables -A ZT_ACL ... │ (Agent tự apply)                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## Tóm tắt

| Thành phần | Vai trò |
|------------|---------|
| **Ansible** | Chỉ deploy 1 lần: cài đặt, khởi động agent |
| **Control Plane API** | Chỉ **trả về dữ liệu** (overlay IP, peers, ACL rules) |
| **Agent (daemon)** | **Tự apply** WireGuard config + iptables rules |

## Tại sao không dùng Ansible runtime?

1. **Latency**: Gọi Ansible mỗi khi có node mới = chậm (5-10s)
2. **Scalability**: 100 nodes = 100 Ansible calls = không scale được
3. **Real-time**: Agent sync mỗi 60s, phản ứng nhanh với policy change
4. **Self-healing**: Agent tự phục hồi nếu config bị thay đổi

## Cách Hub WireGuard biết peer mới?

Khi node mới register, **Hub cũng chạy agent** và sẽ:
1. Gọi `/config` → nhận danh sách tất cả peers
2. `wg set wg0 peer <new_node_pubkey> allowed-ips 10.0.0.X/32`

Hoặc Control Plane có thể chủ động push config tới Hub (webhook/SSE).