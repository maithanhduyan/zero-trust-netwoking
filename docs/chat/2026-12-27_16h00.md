**User:**
C√°ch Tri·ªÉn khai Agents l√™n c√°c node kh√°c (app servers, database servers)
**AI(Claude Opus 4.5):**
Research agent deployment

Read [](file:///home/zero-trust-netwoking/agent)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent)

Read [](file:///home/zero-trust-netwoking/agent/pyproject.toml)

Read [](file:///home/zero-trust-netwoking/docs/WORKFLOW.md#1-1), lines 1 to 200

Read [](file:///home/zero-trust-netwoking/agent/agent.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-netwoking/agent/client.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent/tasks)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent/templates)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent/defaults)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent/tasks/main.yml)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent/tasks/register.yml#1-1), lines 1 to 50

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent/defaults/main.yml)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent/templates/zt-agent.service.j2)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/roles/agent/templates/zt-agent.conf.j2)

Read [](file:///home/zero-trust-netwoking/scripts/install.sh#1-1), lines 1 to 100

Searched for regex `agent.*install|install.*agent` (`**/scripts/**`), no results

Read [](file:///home/zero-trust-netwoking/agent/wireguard/manager.py#1-1), lines 1 to 100

Read [](file:///home/zero-trust-netwoking/agent/collectors/host_info.py#1-1), lines 1 to 100

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/playbook/deploy-agents.yml#1-1), lines 1 to 100

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/playbook/deploy-agents.yml#100-100), lines 100 to 153

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/inventory/group_vars/agent.yml)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/inventory/group_vars/all.yml)

Read [](file:///home/zero-trust-netwoking/infrastructure/ansible/inventory/hosts.ini)

T√¥i s·∫Ω t·∫°o script c√†i ƒë·∫∑t Agent cho c√°c node kh√°c: T√¥i kh√¥ng th·ªÉ t·∫°o file. ƒê√¢y l√† h∆∞·ªõng d·∫´n tri·ªÉn khai Agent:

---

## Tri·ªÉn khai Agent l√™n c√°c Node kh√°c

### C√°ch 1: S·ª≠ d·ª•ng Ansible (Khuy·∫øn ngh·ªã)

T·ª´ **Hub Server**, ch·∫°y:

```bash
cd /home/zero-trust-netwoking/infrastructure/ansible

# C·∫≠p nh·∫≠t inventory v·ªõi c√°c node
cat > inventory/hosts.ini << 'EOF'
[hub]
hub ansible_host=<HUB_PUBLIC_IP> ansible_user=root

[app]
app-01 ansible_host=<APP_SERVER_IP> ansible_user=root node_role=app
app-02 ansible_host=<APP_SERVER_IP_2> ansible_user=root node_role=app

[db]
db-01 ansible_host=<DB_SERVER_IP> ansible_user=root node_role=db

[all:vars]
control_plane_url=http://<HUB_PUBLIC_IP>:8000
hub_endpoint=<HUB_PUBLIC_IP>:51820
hub_public_key=hM7m0pKxxdQzkwREnS3KM9tSK0LBTFlGq+xMSKptRSI=
EOF

# Deploy agents
ansible-playbook -i inventory/hosts.ini playbook/deploy-agents.yml
```

---

### C√°ch 2: C√†i ƒë·∫∑t th·ªß c√¥ng (tr√™n m·ªói Node)

**B∆∞·ªõc 1: SSH v√†o node c·∫ßn c√†i**
```bash
ssh root@<NODE_IP>
```

**B∆∞·ªõc 2: C√†i ƒë·∫∑t dependencies**
```bash
apt-get update
apt-get install -y wireguard wireguard-tools curl git python3 python3-pip python3-venv iptables
```

**B∆∞·ªõc 3: T·∫°o WireGuard keypair**
```bash
mkdir -p /etc/wireguard && chmod 700 /etc/wireguard
wg genkey | tee /etc/wireguard/private.key | wg pubkey > /etc/wireguard/public.key
chmod 600 /etc/wireguard/private.key

# Hi·ªÉn th·ªã public key (c·∫ßn ƒë·ªÉ ƒëƒÉng k√Ω)
cat /etc/wireguard/public.key
```

**B∆∞·ªõc 4: ƒêƒÉng k√Ω v·ªõi Control Plane**
```bash
# Thay th·∫ø c√°c gi√° tr·ªã
HUB_URL="http://<HUB_IP>:8000"
NODE_HOSTNAME="app-01"
NODE_ROLE="app"
NODE_PUBLIC_KEY=$(cat /etc/wireguard/public.key)

curl -X POST "${HUB_URL}/api/v1/agent/register" \
  -H "Content-Type: application/json" \
  -d "{
    \"hostname\": \"${NODE_HOSTNAME}\",
    \"role\": \"${NODE_ROLE}\",
    \"public_key\": \"${NODE_PUBLIC_KEY}\",
    \"description\": \"App server 01\",
    \"agent_version\": \"1.0.0\",
    \"os_info\": \"$(lsb_release -d -s) ($(uname -m))\"
  }"
```

Response s·∫Ω tr·∫£ v·ªÅ `overlay_ip` (v√≠ d·ª•: `10.10.0.2/24`)

**B∆∞·ªõc 5: C·∫•u h√¨nh WireGuard**
```bash
# Thay th·∫ø c√°c gi√° tr·ªã
HUB_PUBLIC_KEY="hM7m0pKxxdQzkwREnS3KM9tSK0LBTFlGq+xMSKptRSI="
HUB_ENDPOINT="<HUB_IP>:51820"
OVERLAY_IP="10.10.0.2/24"  # L·∫•y t·ª´ response ·ªü b∆∞·ªõc 4

cat > /etc/wireguard/wg0.conf << EOF
[Interface]
PrivateKey = $(cat /etc/wireguard/private.key)
Address = ${OVERLAY_IP}

[Peer]
PublicKey = ${HUB_PUBLIC_KEY}
Endpoint = ${HUB_ENDPOINT}
AllowedIPs = 10.10.0.0/24
PersistentKeepalive = 25
EOF

chmod 600 /etc/wireguard/wg0.conf

# Kh·ªüi ƒë·ªông WireGuard
systemctl enable wg-quick@wg0
systemctl start wg-quick@wg0
```

**B∆∞·ªõc 6: Th√™m peer v√†o Hub**

‚ö†Ô∏è **Quan tr·ªçng**: Quay l·∫°i **Hub Server** v√† th√™m peer m·ªõi:

```bash
# Tr√™n Hub Server
wg set wg0 peer <NODE_PUBLIC_KEY> allowed-ips 10.10.0.2/32

# Ho·∫∑c th√™m v√†o config file
cat >> /etc/wireguard/wg0.conf << EOF

[Peer]
# app-01
PublicKey = <NODE_PUBLIC_KEY>
AllowedIPs = 10.10.0.2/32
EOF

# Reload config
wg syncconf wg0 <(wg-quick strip wg0)
```

**B∆∞·ªõc 7: Test k·∫øt n·ªëi**
```bash
# T·ª´ Node, ping Hub
ping 10.10.0.1

# T·ª´ Hub, ping Node
ping 10.10.0.2
```

---

### C√°ch 3: Script t·ª± ƒë·ªông (Copy v√†o Node)

```bash
# Tr√™n Hub, l·∫•y th√¥ng tin c·∫ßn thi·∫øt:
echo "HUB_PUBLIC_KEY=$(cat /etc/wireguard/public.key)"
echo "HUB_ENDPOINT=$(curl -s ifconfig.me):51820"

# Copy command n√†y sang Node v√† ch·∫°y:
curl -sL https://raw.githubusercontent.com/maithanhduyan/zero-trust-netwoking/main/scripts/install-agent.sh | \
  sudo HUB_URL="http://<HUB_IP>:8000" \
       HUB_ENDPOINT="<HUB_IP>:51820" \
       HUB_PUBLIC_KEY="<HUB_PUBLIC_KEY>" \
       NODE_ROLE="app" \
       bash
```

---

### Ki·ªÉm tra sau khi c√†i ƒë·∫∑t

```bash
# Tr√™n Node - Ki·ªÉm tra WireGuard
wg show wg0

# Tr√™n Hub - Xem t·∫•t c·∫£ peers
wg show wg0

# Ki·ªÉm tra nodes ƒë√£ ƒëƒÉng k√Ω
curl http://localhost:8000/api/v1/admin/nodes | jq .
```

B·∫°n mu·ªën t√¥i t·∫°o script `install-agent.sh` ƒë·∫ßy ƒë·ªß kh√¥ng? (C·∫ßn b·∫≠t quy·ªÅn t·∫°o file)


---
**User:**
Start implementation

**AI(Claude Opus 4.5):**
Created [](file:///home/zero-trust-netwoking/scripts/install-agent.sh)

Ran terminal command: chmod +x /home/zero-trust-netwoking/scripts/install-agent.sh && echo "=== Hub Info for Agent Installation ===" && echo "HUB_PUBLIC_KEY=$(cat /etc/wireguard/public.key)" && echo "HUB_ENDPOINT=$(curl -s ifconfig.me):51820" && echo "HUB_URL=http://$(curl -s ifconfig.me):8000"

ƒê√£ t·∫°o `install-agent.sh`. B√¢y gi·ªù t·∫°o script helper ƒë·ªÉ l·∫•y IPv4:

Ran terminal command: PUBLIC_IP=$(curl -4 -s ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}') && echo "=== AGENT INSTALLATION COMMAND ===" && echo "" && echo "# Copy v√† ch·∫°y tr√™n node c·∫ßn c√†i Agent:" && echo "" && echo "curl -sL https://raw.githubusercontent.com/maithanhduyan/zero-trust-netwoking/main/scripts/install-agent.sh | \\" && echo "  sudo HUB_URL=\"http://${PUBLIC_IP}:8000\" \\" && echo "       HUB_ENDPOINT=\"${PUBLIC_IP}:51820\" \\" && echo "       HUB_PUBLIC_KEY=\"$(cat /etc/wireguard/public.key)\" \\" && echo "       NODE_ROLE=\"app\" \\" && echo "       bash"

Summarized conversation history## ‚úÖ Agent Installation Ready!

**Hub Server Info:**
| Property | Value |
|----------|-------|
| Hub IP | `192.168.1.10` |
| API URL | `http://192.168.1.10:8000` |
| WireGuard Endpoint | `192.168.1.10:51820` |
| Public Key | `hM7m0pKxxdQzkwREnS3KM9tSK0LBTFlGq+xMSKptRSI=` |

---

### üìã ƒê·ªÉ tri·ªÉn khai Agent l√™n node kh√°c:

**1. SSH v√†o node c·∫ßn c√†i ƒë·∫∑t:**
```bash
ssh user@<app-server-ip>
```

**2. Ch·∫°y l·ªánh c√†i ƒë·∫∑t (thay `NODE_ROLE` ph√π h·ª£p):**

```bash
# Cho App Server
curl -sL https://raw.githubusercontent.com/maithanhduyan/zero-trust-netwoking/main/scripts/install-agent.sh | \
  sudo HUB_URL="http://192.168.1.10:8000" \
       HUB_ENDPOINT="192.168.1.10:51820" \
       HUB_PUBLIC_KEY="hM7m0pKxxdQzkwREnS3KM9tSK0LBTFlGq+xMSKptRSI=" \
       NODE_ROLE="app" \
       bash

# Cho Database Server
curl -sL ... NODE_ROLE="db" bash

# Cho Ops/Monitoring
curl -sL ... NODE_ROLE="ops" bash
```

**3. Sau khi Agent c√†i xong, quay l·∫°i Hub th√™m peer:**

Script s·∫Ω hi·ªÉn th·ªã l·ªánh c·∫ßn ch·∫°y tr√™n Hub:
```bash
wg set wg0 peer <AGENT_PUBLIC_KEY> allowed-ips 10.10.0.X/32
wg-quick save wg0
```

---

### üîê C√°c role h·ª£p l·ªá:
| Role | M√¥ t·∫£ | Allowed Connections |
|------|-------|---------------------|
| `app` | Application server | ‚Üí db:5432, ‚Üí ops:* |
| `db` | Database server | ‚Üê app:5432 only |
| `ops` | Operations/Monitoring | ‚Üî all (admin) |
| `hub` | WireGuard Hub | routing only |

B·∫°n mu·ªën t√¥i push script l√™n GitHub ho·∫∑c test c√†i ƒë·∫∑t th·ª≠ tr√™n m·ªôt node?

---
