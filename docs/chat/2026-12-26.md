Dá»±a trÃªn tÃ i liá»‡u **NIST Special Publication 800-207: Zero Trust Architecture** mÃ  báº¡n cung cáº¥p, dÆ°á»›i Ä‘Ã¢y lÃ  báº£n tÃ³m táº¯t vÃ  hÆ°á»›ng dáº«n thiáº¿t káº¿ há»‡ thá»‘ng **Zero Trust Networking (ZTA)**. TÃ i liá»‡u nÃ y Ä‘Æ°á»£c cáº¥u trÃºc Ä‘á»ƒ giÃºp cÃ¡c kiáº¿n trÃºc sÆ° báº£o máº­t vÃ  quáº£n trá»‹ viÃªn há»‡ thá»‘ng hiá»ƒu vÃ  lÃªn káº¿ hoáº¡ch triá»ƒn khai.

---

# TÃ€I LIá»†U THIáº¾T Káº¾ KIáº¾N TRÃšC ZERO TRUST (ZTA)

_(Dá»±a trÃªn chuáº©n NIST SP 800-207)_

## 1. Tá»•ng quan vÃ  Äá»‹nh nghÄ©a

**Zero Trust (ZT)** khÃ´ng pháº£i lÃ  má»™t cÃ´ng nghá»‡ Ä‘Æ¡n láº» mÃ  lÃ  má»™t táº­p há»£p cÃ¡c nguyÃªn táº¯c an ninh máº¡ng. TÆ° duy cá»‘t lÃµi lÃ  chuyá»ƒn dá»‹ch tá»« viá»‡c báº£o vá»‡ "biÃªn máº¡ng" (network perimeter) tÄ©nh sang táº­p trung báº£o vá»‡ **ngÆ°á»i dÃ¹ng (users), tÃ i sáº£n (assets) vÃ  tÃ i nguyÃªn (resources)**.

- **NguyÃªn lÃ½ cÄƒn báº£n:** "KhÃ´ng bao giá» tin tÆ°á»Ÿng, luÃ´n luÃ´n xÃ¡c minh" (Never trust, always verify). KhÃ´ng cÃ³ sá»± tin tÆ°á»Ÿng ngáº§m Ä‘á»‹nh (implicit trust) cho báº¥t ká»³ tÃ i sáº£n hay tÃ i khoáº£n ngÆ°á»i dÃ¹ng nÃ o chá»‰ dá»±a trÃªn vá»‹ trÃ­ váº­t lÃ½ hoáº·c vá»‹ trÃ­ máº¡ng (vÃ­ dá»¥: máº¡ng LAN ná»™i bá»™ hay Internet).

## 2. Báº£y NguyÃªn táº¯c Cá»‘t lÃµi cá»§a Zero Trust (The 7 Tenets)

Má»i thiáº¿t káº¿ ZTA pháº£i tuÃ¢n thá»§ 7 nguyÃªn táº¯c sau:

1.  **Táº¥t cáº£ dá»¯ liá»‡u vÃ  dá»‹ch vá»¥ tÃ­nh toÃ¡n Ä‘á»u lÃ  TÃ€I NGUYÃŠN:** Bao gá»“m cáº£ thiáº¿t bá»‹ cÃ¡ nhÃ¢n (BYOD), thiáº¿t bá»‹ IoT, vÃ  cÃ¡c dá»‹ch vá»¥ Ä‘Ã¡m mÃ¢y (SaaS).
2.  **Báº£o máº­t má»i giao tiáº¿p báº¥t ká»ƒ vá»‹ trÃ­ máº¡ng:** Truy cáº­p tá»« máº¡ng ná»™i bá»™ cÅ©ng pháº£i Ä‘Ã¡p á»©ng cÃ¡c tiÃªu chuáº©n báº£o máº­t kháº¯t khe nhÆ° truy cáº­p tá»« bÃªn ngoÃ i (mÃ£ hÃ³a, xÃ¡c thá»±c).
3.  **Truy cáº­p tÃ i nguyÃªn Ä‘Æ°á»£c cáº¥p theo tá»«ng PHIÃŠN (Per-session):** Sá»± tin tÆ°á»Ÿng Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ láº¡i trÆ°á»›c má»—i káº¿t ná»‘i. Viá»‡c xÃ¡c thá»±c vÃ o máº¡ng khÃ´ng Ä‘á»“ng nghÄ©a vá»›i viá»‡c Ä‘Æ°á»£c quyá»n truy cáº­p vÃ o á»©ng dá»¥ng.
4.  **Truy cáº­p Ä‘Æ°á»£c quyáº¿t Ä‘á»‹nh bá»Ÿi CHÃNH SÃCH Äá»˜NG (Dynamic Policy):** Quyáº¿t Ä‘á»‹nh cáº¥p quyá»n dá»±a trÃªn:
    - Danh tÃ­nh Ä‘á»‘i tÆ°á»£ng (User ID).
    - Tráº¡ng thÃ¡i thiáº¿t bá»‹ (Device health/posture).
    - HÃ nh vi ngÆ°á»i dÃ¹ng.
    - MÃ´i trÆ°á»ng (Thá»i gian, vá»‹ trÃ­ Ä‘á»‹a lÃ½).
5.  **GiÃ¡m sÃ¡t vÃ  Ä‘o lÆ°á»ng tráº¡ng thÃ¡i an ninh cá»§a má»i tÃ i sáº£n:** KhÃ´ng cÃ³ thiáº¿t bá»‹ nÃ o lÃ  tin cáº­y tuyá»‡t Ä‘á»‘i. Há»‡ thá»‘ng pháº£i liÃªn tá»¥c quÃ©t lá»— há»•ng vÃ  tráº¡ng thÃ¡i báº£n vÃ¡ (CDM).
6.  **XÃ¡c thá»±c vÃ  á»§y quyá»n liÃªn tá»¥c:** Sá»­ dá»¥ng Äa yáº¿u tá»‘ xÃ¡c thá»±c (MFA) vÃ  kiá»ƒm tra láº¡i liÃªn tá»¥c trong suá»‘t quÃ¡ trÃ¬nh káº¿t ná»‘i, khÃ´ng chá»‰ táº¡i thá»i Ä‘iá»ƒm Ä‘Äƒng nháº­p.
7.  **Thu tháº­p thÃ´ng tin Ä‘á»ƒ cáº£i thiá»‡n báº£o máº­t:** DÃ¹ng dá»¯ liá»‡u máº¡ng, log truy cáº­p Ä‘á»ƒ phÃ¢n tÃ­ch vÃ  tá»‘i Æ°u hÃ³a chÃ­nh sÃ¡ch báº£o máº­t.

## 3. CÃ¡c ThÃ nh pháº§n Logic trong Kiáº¿n trÃºc (Logical Components)

Há»‡ thá»‘ng ZTA Ä‘Æ°á»£c chia lÃ m hai pháº§n: **Control Plane** (Máº·t pháº³ng Ä‘iá»u khiá»ƒn) vÃ  **Data Plane** (Máº·t pháº³ng dá»¯ liá»‡u).

### A. Core Components (ThÃ nh pháº§n cá»‘t lÃµi)

1.  **Policy Engine (PE - Bá»™ mÃ¡y chÃ­nh sÃ¡ch):** "Bá»™ nÃ£o" cá»§a há»‡ thá»‘ng. Chá»‹u trÃ¡ch nhiá»‡m ra quyáº¿t Ä‘á»‹nh (Cho phÃ©p/Tá»« chá»‘i) dá»±a trÃªn chÃ­nh sÃ¡ch vÃ  thuáº­t toÃ¡n tin cáº­y (Trust Algorithm).
2.  **Policy Administrator (PA - Quáº£n trá»‹ chÃ­nh sÃ¡ch):** NgÆ°á»i thá»±c thi quyáº¿t Ä‘á»‹nh cá»§a PE. PA sáº½ ra lá»‡nh táº¡o hoáº·c ngáº¯t káº¿t ná»‘i.
3.  **Policy Enforcement Point (PEP - Äiá»ƒm thá»±c thi chÃ­nh sÃ¡ch):** Cá»•ng káº¿t ná»‘i (Gateway/Agent). ÄÃ¢y lÃ  nÆ¡i duy nháº¥t luá»“ng dá»¯ liá»‡u Ä‘i qua. PEP cháº·n má»i truy cáº­p cho Ä‘áº¿n khi PA cho phÃ©p.

### B. Input Data Sources (Nguá»“n dá»¯ liá»‡u Ä‘áº§u vÃ o cho PE)

Äá»ƒ PE ra quyáº¿t Ä‘á»‹nh chÃ­nh xÃ¡c, cáº§n tÃ­ch há»£p dá»¯ liá»‡u tá»«:

- **CDM System:** Tráº¡ng thÃ¡i sá»©c khá»e thiáº¿t bá»‹.
- **Threat Intelligence:** ThÃ´ng tin vá» cÃ¡c má»‘i Ä‘e dá»a má»›i nháº¥t.
- **ID Management:** Há»‡ thá»‘ng quáº£n lÃ½ danh tÃ­nh (LDAP, AD).
- **SIEM:** Nháº­t kÃ½ hoáº¡t Ä‘á»™ng vÃ  sá»± kiá»‡n báº£o máº­t.

## 4. CÃ¡c MÃ´ hÃ¬nh Triá»ƒn khai Phá»• biáº¿n (Deployment Variations)

TÃ¹y thuá»™c vÃ o háº¡ táº§ng hiá»‡n cÃ³, báº¡n cÃ³ thá»ƒ chá»n má»™t trong cÃ¡c mÃ´ hÃ¬nh sau:

1.  **Device Agent/Gateway-Based:**
    - CÃ i Ä‘áº·t Agent trÃªn thiáº¿t bá»‹ ngÆ°á»i dÃ¹ng vÃ  Gateway trÆ°á»›c tÃ i nguyÃªn.
    - PhÃ¹ há»£p nháº¥t cho doanh nghiá»‡p kiá»ƒm soÃ¡t cháº·t cháº½ thiáº¿t bá»‹ (Enterprise-owned devices).
2.  **Enclave-Based:**
    - Gateway Ä‘áº·t trÆ°á»›c má»™t nhÃ³m tÃ i nguyÃªn (vÃ­ dá»¥: má»™t trung tÃ¢m dá»¯ liá»‡u cÅ© - Legacy DC).
    - PhÃ¹ há»£p cho cÃ¡c há»‡ thá»‘ng cÅ© khÃ´ng há»— trá»£ cÃ i Ä‘áº·t Agent trá»±c tiáº¿p.
3.  **Resource Portal-Based:**
    - Gateway Ä‘Ã³ng vai trÃ² lÃ  má»™t cá»•ng web (Portal). NgÆ°á»i dÃ¹ng truy cáº­p qua trÃ¬nh duyá»‡t.
    - PhÃ¹ há»£p cho BYOD hoáº·c Ä‘á»‘i tÃ¡c bÃªn ngoÃ i (Contractors) mÃ  khÃ´ng cáº§n cÃ i Agent.
4.  **Application Sandboxing:**
    - Cháº¡y á»©ng dá»¥ng trong cÃ¡c container/mÃ¡y áº£o cÃ´ láº­p trÃªn thiáº¿t bá»‹.

## 5. Thuáº­t toÃ¡n Tin cáº­y (Trust Algorithm)

Quyáº¿t Ä‘á»‹nh truy cáº­p dá»±a trÃªn cÃ´ng thá»©c:
`Truy cáº­p = f(NgÆ°á»i dÃ¹ng, Thiáº¿t bá»‹, Ngá»¯ cáº£nh, Má»©c Ä‘á»™ nháº¡y cáº£m cá»§a dá»¯ liá»‡u)`

- **Criteria-based:** Dá»±a trÃªn tiÃªu chÃ­ cá»©ng (VÃ­ dá»¥: Pháº£i thuá»™c nhÃ³m Admin VÃ€ thiáº¿t bá»‹ Ä‘Ã£ update Windows má»›i nháº¥t).
- **Score-based:** TÃ­nh Ä‘iá»ƒm tin cáº­y (Confidence Score). Náº¿u Ä‘iá»ƒm > ngÆ°á»¡ng quy Ä‘á»‹nh -> Cho phÃ©p.

## 6. Lá»™ trÃ¬nh Chuyá»ƒn Ä‘á»•i sang ZTA (Migration Roadmap)

Viá»‡c chuyá»ƒn Ä‘á»•i khÃ´ng thá»ƒ diá»…n ra trong má»™t sá»›m má»™t chiá»u. NIST Ä‘á» xuáº¥t quy trÃ¬nh sau:

1.  **XÃ¡c Ä‘á»‹nh Äá»‘i tÆ°á»£ng (Actors):** Ai lÃ  nhÃ¢n viÃªn, ai lÃ  Ä‘á»‘i tÃ¡c, cÃ¡c tÃ i khoáº£n dá»‹ch vá»¥ (non-person entities).
2.  **XÃ¡c Ä‘á»‹nh TÃ i sáº£n (Assets):** Kiá»ƒm kÃª toÃ n bá»™ thiáº¿t bá»‹ vÃ  dá»¯ liá»‡u (Data classification).
3.  **XÃ¡c Ä‘á»‹nh Quy trÃ¬nh nghiá»‡p vá»¥ (Business Processes):** Chá»n má»™t quy trÃ¬nh Ã­t rá»§i ro Ä‘á»ƒ thá»­ nghiá»‡m trÆ°á»›c.
4.  **XÃ¢y dá»±ng ChÃ­nh sÃ¡ch (Formulating Policies):** Ai Ä‘Æ°á»£c truy cáº­p cÃ¡i gÃ¬, trong Ä‘iá»u kiá»‡n nÃ o? (Whitelist approach).
5.  **Lá»±a chá»n Giáº£i phÃ¡p (Identifying Solutions):** Chá»n cÃ´ng nghá»‡ phÃ¹ há»£p (SDP, Micro-segmentation, Identity-aware proxy...).
6.  **Triá»ƒn khai ban Ä‘áº§u & GiÃ¡m sÃ¡t (Initial Deployment):** Cháº¡y á»Ÿ cháº¿ Ä‘á»™ "Chá»‰ theo dÃµi" (Audit/Log only) Ä‘á»ƒ tinh chá»‰nh chÃ­nh sÃ¡ch, trÃ¡nh lÃ m giÃ¡n Ä‘oáº¡n cÃ´ng viá»‡c.
7.  **Má»Ÿ rá»™ng (Expanding):** Ãp dá»¥ng cháº¿ Ä‘á»™ thá»±c thi (Enforcement) vÃ  má»Ÿ rá»™ng sang cÃ¡c quy trÃ¬nh nghiá»‡p vá»¥ khÃ¡c.

## 7. CÃ¡c Má»‘i Ä‘e dá»a & Rá»§i ro

Khi triá»ƒn khai ZTA, cáº§n lÆ°u Ã½:

- **Táº¥n cÃ´ng vÃ o Control Plane (PE/PA):** Náº¿u PE/PA bá»‹ chiáº¿m quyá»n hoáº·c bá»‹ DDoS, toÃ n bá»™ hoáº¡t Ä‘á»™ng truy cáº­p sáº½ bá»‹ tÃª liá»‡t. Cáº§n báº£o vá»‡ ká»¹ lÆ°á»¡ng cÃ¡c thÃ nh pháº§n nÃ y.
- **ÄÃ¡nh cáº¯p tÃ i khoáº£n (Stolen Credentials):** ZTA giáº£m thiá»ƒu rá»§i ro nÃ y báº±ng MFA vÃ  Trust Algorithm ngá»¯ cáº£nh (vÃ­ dá»¥: phÃ¡t hiá»‡n hÃ nh vi báº¥t thÆ°á»ng dÃ¹ Ä‘Ãºng máº­t kháº©u), nhÆ°ng khÃ´ng loáº¡i bá» hoÃ n toÃ n.
- **Phá»¥ thuá»™c vÃ o nhÃ  cung cáº¥p (Vendor Lock-in):** Do thiáº¿u cÃ¡c tiÃªu chuáº©n giao tiáº¿p chung giá»¯a cÃ¡c thÃ nh pháº§n ZT.

---

_TÃ i liá»‡u nÃ y tÃ³m táº¯t cÃ¡c Ä‘iá»ƒm chÃ­nh yáº¿u tá»« NIST SP 800-207 Ä‘á»ƒ há»— trá»£ viá»‡c thiáº¿t káº¿ há»‡ thá»‘ng báº£o máº­t hiá»‡n Ä‘áº¡i._
Dá»±a trÃªn nguyÃªn lÃ½ **NIST SP 800-207** vÃ  yÃªu cáº§u tá»± chá»§ (Self-hosted Custom WireGuard) mÃ  báº¡n Ä‘Ã£ chá»n, Ä‘Ã¢y lÃ  cáº¥u trÃºc thÆ° má»¥c chuáº©n cho dá»± Ã¡n `zero-trust-networking`.

Cáº¥u trÃºc nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ theo mÃ´ hÃ¬nh **Monorepo** Ä‘á»ƒ dá»… quáº£n lÃ½ phiÃªn báº£n Ä‘á»“ng nháº¥t giá»¯a Control Plane (Server) vÃ  Agent (Client).

### Cáº¥u trÃºc thÆ° má»¥c tá»•ng quÃ¡t

```text
zero-trust-networking/
â”œâ”€â”€ control-plane/           # (NÃƒO Bá»˜) Server quáº£n lÃ½ trung tÃ¢m
â”‚   â”œâ”€â”€ api/                 # Interface giao tiáº¿p vá»›i Agent vÃ  Admin
â”‚   â”œâ”€â”€ core/                # Logic nghiá»‡p vá»¥ cá»‘t lÃµi
â”‚   â”œâ”€â”€ database/            # LÆ°u trá»¯ tráº¡ng thÃ¡i (Postgres/SQLite)
â”‚   â”œâ”€â”€ policy-engine/       # (PDP) NÆ¡i ra quyáº¿t Ä‘á»‹nh Trust Algorithm
â”‚   â””â”€â”€ web-ui/              # (Optional) Dashboard quáº£n trá»‹
â”‚
â”œâ”€â”€ agent/                   # (TAY CHÃ‚N) Cháº¡y trÃªn tá»«ng VPS/Client
â”‚   â”œâ”€â”€ core/                # Logic káº¿t ná»‘i API, Heartbeat
â”‚   â”œâ”€â”€ wireguard/           # Quáº£n lÃ½ Interface WG, Key pair
â”‚   â””â”€â”€ firewall/            # (PEP) Quáº£n lÃ½ iptables/nftables
â”‚
â”œâ”€â”€ policies/                # (LUáº¬T) Äá»‹nh nghÄ©a Policy-as-Code
â”‚   â”œâ”€â”€ access-control/      # Ai Ä‘Æ°á»£c gáº·p ai (ACLs)
â”‚   â””â”€â”€ compliance/          # YÃªu cáº§u vá» OS, version...
â”‚
â”œâ”€â”€ infrastructure/          # (CÆ  Báº®P) Automation & Deployment
â”‚   â”œâ”€â”€ ansible/             # Playbooks cÃ i Ä‘áº·t (nhÆ° Ä‘Ã£ bÃ n á»Ÿ trÃªn)
â”‚   â”œâ”€â”€ docker/              # Dockerfile cho Control Plane
â”‚   â””â”€â”€ scripts/             # Helper scripts (keygen, bootstrap)
â”‚
â”œâ”€â”€ docs/                    # TÃ i liá»‡u kiáº¿n trÃºc & váº­n hÃ nh
â”œâ”€â”€ tests/                   # E2E Testing
â”œâ”€â”€ docker-compose.yml       # Dev environment
â”œâ”€â”€ Makefile                 # Shortcuts lá»‡nh
â””â”€â”€ README.md
```

---

### Chi tiáº¿t tá»«ng thÃ nh pháº§n (Deep Dive)

#### 1. `control-plane/` (Policy Administrator - PA)

ÄÃ¢y lÃ  nÆ¡i chá»©a API server. NÃ³ **khÃ´ng** xá»­ lÃ½ gÃ³i tin dá»¯ liá»‡u (Data Plane), nÃ³ chá»‰ phÃ¢n phá»‘i cáº¥u hÃ¬nh.

```text
control-plane/
â”œâ”€â”€ main.py                  # Entrypoint (FastAPI/Go)
â”œâ”€â”€ config.py                # Load biáº¿n mÃ´i trÆ°á»ng
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”œâ”€â”€ endpoints.py     # /register, /sync, /heartbeat
â”‚   â”‚   â””â”€â”€ admin.py         # API cho ngÆ°á»i quáº£n trá»‹
â”‚   â””â”€â”€ dependencies.py      # Auth middleware (mTLS/Token)
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ key_manager.py       # Quáº£n lÃ½ Public Keys
â”‚   â””â”€â”€ ipam.py              # Cáº¥p phÃ¡t IP áº£o (10.10.0.x)
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ models.py            # Node, Peer, Policy tables
â”‚   â””â”€â”€ migrations/          # Alembic/SQL migration scripts
â””â”€â”€ policy-engine/           # QUAN TRá»ŒNG NHáº¤T
    â”œâ”€â”€ evaluator.py         # HÃ m tÃ­nh Ä‘iá»ƒm tin cáº­y (Trust Score)
    â””â”€â”€ compiler.py          # Chuyá»ƒn Policy -> WireGuard Config + IPTables
```

- **Äiá»ƒm nháº¥n:** Module `policy-engine` tÃ¡ch biá»‡t. Khi API nháº­n request tá»« Agent, nÃ³ pháº£i há»i `policy-engine` trÆ°á»›c khi tráº£ vá» config.

#### 2. `agent/` (Policy Enforcement Point - PEP)

Cháº¡y trÃªn má»—i VPS (Odoo, Postgres, Ops). NÃ³ pháº£i cá»±c nháº¹ vÃ  á»•n Ä‘á»‹nh.

```text
agent/
â”œâ”€â”€ agent.py                 # Main loop (Scheduler)
â”œâ”€â”€ client.py                # HTTP Client gá»i vá» Control Plane (mTLS)
â”œâ”€â”€ wireguard/
â”‚   â”œâ”€â”€ manager.py           # Gá»i lá»‡nh `wg`, `wg-quick`
â”‚   â””â”€â”€ config_builder.py    # Táº¡o file wg0.conf tá»« JSON
â”œâ”€â”€ firewall/
â”‚   â”œâ”€â”€ iptables.py          # Wrapper lá»‡nh iptables
â”‚   â””â”€â”€ nftables.py          # (Future proof)
â””â”€â”€ collectors/              # Thu tháº­p thÃ´ng tin cho Trust Algorithm
    â”œâ”€â”€ host_info.py         # Láº¥y OS version, uptime
    â””â”€â”€ network_stats.py     # Láº¥y thÃ´ng tin traffic
```

- **Äiá»ƒm nháº¥n:** `firewall` module lÃ  nÆ¡i thá»±c thi Zero Trust. Náº¿u Control Plane báº£o "Cáº¥m", module nÃ y sáº½ `DROP` gÃ³i tin ngay táº¡i mÃ¡y, trÆ°á»›c khi nÃ³ vÃ o Ä‘áº¿n á»©ng dá»¥ng.

#### 3. `policies/` (Policy as Code)

Thay vÃ¬ lÆ°u cá»©ng trong Database, policy nÃªn Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a báº±ng code (YAML/JSON) Ä‘á»ƒ cÃ³ thá»ƒ Review vÃ  Version Control.

```text
policies/
â”œâ”€â”€ global.yaml              # Policy máº·c Ä‘á»‹nh (VD: Deny All)
â”œâ”€â”€ roles/
â”‚   â”œâ”€â”€ database.yaml        # Role: Postgres (Allow port 5432 from App)
â”‚   â”œâ”€â”€ app.yaml             # Role: Odoo (Allow outbound to DB)
â”‚   â””â”€â”€ ops.yaml             # Role: Admin (Allow SSH)
â””â”€â”€ users/
    â””â”€â”€ admin-team.yaml      # Mapping user -> role
```

- **Logic:** Control Plane sáº½ Ä‘á»c cÃ¡c file nÃ y khi khá»Ÿi Ä‘á»™ng hoáº·c khi cÃ³ trigger reload Ä‘á»ƒ cáº­p nháº­t vÃ o Database/Memory.

#### 4. `infrastructure/` (Ansible & Deployment)

NÆ¡i chá»©a code Ä‘á»ƒ triá»ƒn khai há»‡ thá»‘ng nÃ y ra 4 VPS thá»±c táº¿.

```text
infrastructure/
â”œâ”€â”€ ansible/
â”‚   â”œâ”€â”€ inventory/
â”‚   â”‚   â””â”€â”€ hosts.ini
â”‚   â”œâ”€â”€ roles/
â”‚   â”‚   â”œâ”€â”€ common/          # CÃ i Python, Docker
â”‚   â”‚   â”œâ”€â”€ control-plane/   # Deploy Docker container Control Plane
â”‚   â”‚   â””â”€â”€ agent/           # CÃ i Systemd service cho Agent
â”‚   â””â”€â”€ deploy-site.yml
â””â”€â”€ docker/
    â””â”€â”€ Dockerfile.control   # Image cho Control Plane
```

---

### Workflow hoáº¡t Ä‘á»™ng (VÃ­ dá»¥)

1.  **Khá»Ÿi táº¡o:**

    - Báº¡n Ä‘á»‹nh nghÄ©a file `policies/roles/database.yaml`: _Chá»‰ cho phÃ©p `role:app` káº¿t ná»‘i port `5432`_.
    - Báº¡n cháº¡y `ansible` Ä‘á»ƒ deploy Control Plane lÃªn VPS-1 vÃ  Agent lÃªn VPS-2 (App), VPS-3 (DB).

2.  **ÄÄƒng kÃ½ (Registration):**

    - Agent táº¡i VPS-3 (DB) khá»Ÿi Ä‘á»™ng, sinh Key, gá»i API `/register` vá»›i thÃ´ng tin `role: database`.
    - Control Plane lÆ°u thÃ´ng tin, chÆ°a cáº¥p quyá»n ngay (Pending Approval).

3.  **Cáº¥p phÃ©p (Trust Evaluation):**

    - Báº¡n (Admin) approve node VPS-3.
    - `policy-engine` tÃ­nh toÃ¡n: Node nÃ y lÃ  DB, váº­y nÃ³ cáº§n má»Ÿ port 5432 cho ai? -> Cho `role: app`.

4.  **Äá»“ng bá»™ (Synchronization):**
    - Agent táº¡i VPS-3 gá»i `/sync`.
    - Control Plane tráº£ vá»:
      - WireGuard Peer: VPS-1 (Hub), VPS-2 (App).
      - Firewall Rule: `ALLOW TCP 5432 FROM 10.10.0.2 (VPS-2 IP)`.
    - Agent táº¡i VPS-3 apply config nÃ y.

## Káº¿t quáº£: **Zero Trust Ä‘áº¡t Ä‘Æ°á»£c.** VPS-2 tháº¥y VPS-3 qua tunnel, nhÆ°ng chá»‰ vÃ o Ä‘Æ°á»£c port 5432. SSH (port 22) bá»‹ cháº·n bá»Ÿi iptables do Agent quáº£n lÃ½ (trá»« khi policy cho phÃ©p).

ÄÃ¢y lÃ  script `install.sh` Ä‘á»ƒ khá»Ÿi táº¡o cáº¥u trÃºc dá»± Ã¡n **Zero Trust Networking**.

Script nÃ y khÃ´ng chá»‰ táº¡o thÆ° má»¥c rá»—ng, mÃ  cÃ²n **tá»± Ä‘á»™ng sinh mÃ£ nguá»“n máº«u (boilerplate code)** cho API (FastAPI), Agent (Python), Policy (YAML) vÃ  Ansible Ä‘á»ƒ báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u code logic ngay láº­p tá»©c.

### Ná»™i dung file `install.sh`

```bash
#!/bin/bash

# ==============================================================================
#  ZERO TRUST PROJECT SCAFFOLDING SCRIPT
#  ----------------------------------------------------------------------------
#  Má»¥c tiÃªu: Khá»Ÿi táº¡o cáº¥u trÃºc Monorepo chuáº©n NIST SP 800-207
#  Bao gá»“m: Control Plane (FastAPI), Agent, Policy-as-Code, Infrastructure
# ==============================================================================

set -e

# --- Cáº¤U HÃŒNH ---
PROJECT_NAME="zero-trust-networking"
CURRENT_DIR=$(pwd)
TARGET_DIR="$CURRENT_DIR/$PROJECT_NAME"

# MÃ u sáº¯c
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# --- HÃ€M Há»– TRá»¢ ---
log() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[DONE]${NC} $1"; }

create_file() {
    local path="$1"
    local content="$2"
    if [ ! -f "$path" ]; then
        echo "$content" > "$path"
    fi
}

# --- Báº®T Äáº¦U ---

if [ -d "$TARGET_DIR" ]; then
    echo "ThÆ° má»¥c $PROJECT_NAME Ä‘Ã£ tá»“n táº¡i. Báº¡n cÃ³ muá»‘n tiáº¿p tá»¥c? (y/n)"
    read -r response
    if [[ "$response" != "y" ]]; then exit 1; fi
fi

mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

log "1. Khá»Ÿi táº¡o cáº¥u trÃºc Control Plane (The Brain)..."
mkdir -p control-plane/{api/v1,core,database/migrations,policy-engine,tests}
touch control-plane/__init__.py

# Táº¡o file main.py máº«u cho Control Plane
create_file "control-plane/main.py" "from fastapi import FastAPI
from api.v1 import endpoints

app = FastAPI(title='Zero Trust Control Plane', version='1.0.0')

app.include_router(endpoints.router, prefix='/api/v1')

@app.get('/health')
def health_check():
    return {'status': 'active', 'component': 'control-plane'}"

# Táº¡o file endpoints máº«u
create_file "control-plane/api/v1/endpoints.py" "from fastapi import APIRouter

router = APIRouter()

@router.post('/register')
def register_node(node_data: dict):
    # TODO: Call Policy Engine here
    return {'status': 'pending_approval', 'node_id': 'tmp-123'}"

# Táº¡o file Policy Engine máº«u
create_file "control-plane/policy-engine/evaluator.py" "class TrustEvaluator:
    def evaluate(self, subject, resource, context):
        # NIST SP 800-207 Trust Algorithm
        score = 0
        # Logic tÃ­nh Ä‘iá»ƒm tin cáº­y
        return score >= 80"

create_file "control-plane/requirements.txt" "fastapi
uvicorn
sqlalchemy
alembic
pydantic
psycopg2-binary"

log "2. Khá»Ÿi táº¡o cáº¥u trÃºc Agent (The Muscles)..."
mkdir -p agent/{core,wireguard,firewall,collectors,tests}
touch agent/__init__.py

# Táº¡o file agent.py máº«u
create_file "agent/agent.py" "import time
import logging

class ZeroTrustAgent:
    def __init__(self):
        self.node_id = None

    def heartbeat(self):
        # Gá»­i thÃ´ng tin vá» Control Plane
        pass

    def run(self):
        logging.info('Agent starting...')
        while True:
            self.heartbeat()
            time.sleep(60)

if __name__ == '__main__':
    ZeroTrustAgent().run()"

# Táº¡o module firewall máº«u
create_file "agent/firewall/iptables.py" "import subprocess

def apply_rule(src_ip, port, proto='tcp'):
    cmd = f'iptables -A INPUT -s {src_ip} -p {proto} --dport {port} -j ACCEPT'
    # subprocess.run(cmd, shell=True)"

create_file "agent/requirements.txt" "requests
schedule
psutil
netifaces"

log "3. Khá»Ÿi táº¡o cáº¥u trÃºc Policies (The Law)..."
mkdir -p policies/{roles,global,users}

# Táº¡o Policy máº«u cho Database
create_file "policies/roles/database.yaml" "kind: Role
metadata:
  name: postgres-primary
  tags:
    - tag:db
    - tag:prod
spec:
  inbound:
    - port: 5432
      protocol: tcp
      allow_from:
        - role: odoo-app
  compliance:
    os: ubuntu-22.04
    encryption: required"

# Táº¡o Policy máº«u cho App
create_file "policies/roles/app.yaml" "kind: Role
metadata:
  name: odoo-app
spec:
  outbound:
    - role: postgres-primary"

log "4. Khá»Ÿi táº¡o Infrastructure (Automation)..."
mkdir -p infrastructure/ansible/{inventory,roles,playbooks}
mkdir -p infrastructure/docker
mkdir -p infrastructure/scripts

# Táº¡o Dockerfile cho Control Plane
create_file "infrastructure/docker/Dockerfile.control" "FROM python:3.10-slim
WORKDIR /app
COPY control-plane/requirements.txt .
RUN pip install -r requirements.txt
COPY control-plane .
CMD [\"uvicorn\", \"main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"]"

# Táº¡o Ansible Inventory máº«u
create_file "infrastructure/ansible/inventory/hosts.ini" "[control_plane]
vps-1

[agents]
vps-2
vps-3
vps-4"

log "5. Táº¡o cÃ¡c file cáº¥u hÃ¬nh gá»‘c..."
create_file "README.md" "# Zero Trust Networking Platform

## Architecture
- **Control Plane**: FastAPI (Decision Point)
- **Agent**: Python + WireGuard (Enforcement Point)
- **Policy**: YAML based

## Quick Start
1. Run \`make install\`
2. Run \`make up\`"

create_file "Makefile" "install:
	pip install -r control-plane/requirements.txt
	pip install -r agent/requirements.txt

up:
	docker-compose up -d

test:
	pytest"

# Táº¡o docker-compose Ä‘á»ƒ dev local
create_file "docker-compose.yml" "version: '3.8'
services:
  control-plane:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.control
    ports:
      - '8000:8000'
    volumes:
      - ./control-plane:/app
    environment:
      - DB_URL=postgresql://user:pass@db:5432/zt_db

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: zt_db"

success "Dá»± Ã¡n Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o táº¡i: $TARGET_DIR"
echo "--------------------------------------------------------"
echo "BÆ°á»›c tiáº¿p theo:"
echo "1. cd $PROJECT_NAME"
echo "2. KhÃ¡m phÃ¡ cáº¥u trÃºc thÆ° má»¥c"
echo "3. Báº¯t Ä‘áº§u code logic táº¡i control-plane/policy-engine/"
echo "--------------------------------------------------------"
```

### CÃ¡ch sá»­ dá»¥ng

1.  LÆ°u Ä‘oáº¡n mÃ£ trÃªn vÃ o file `install.sh`.
2.  Cáº¥p quyá»n thá»±c thi:
    ```bash
    chmod +x install.sh
    ```
3.  Cháº¡y script táº¡i thÆ° má»¥c báº¡n muá»‘n chá»©a dá»± Ã¡n:
    ```bash
    ./install.sh
    ```

### Káº¿t quáº£ báº¡n nháº­n Ä‘Æ°á»£c

Sau khi cháº¡y, báº¡n sáº½ cÃ³ ngay má»™t dá»± Ã¡n **Ä‘á»§ tiÃªu chuáº©n** Ä‘á»ƒ báº¯t Ä‘áº§u phÃ¡t triá»ƒn, khÃ´ng pháº£i lo nghÄ© vá» viá»‡c Ä‘áº·t file á»Ÿ Ä‘Ã¢u.

- **`control-plane/`**: ÄÃ£ cÃ³ sáºµn FastAPI server cháº¡y Ä‘Æ°á»£c ngay.
- **`agent/`**: ÄÃ£ cÃ³ khung sÆ°á»n cho Agent cháº¡y ngáº§m.
- **`policies/`**: ÄÃ£ cÃ³ vÃ­ dá»¥ vá» Role-based policy (Odoo Ä‘Æ°á»£c gá»i Postgres).
- **`infrastructure/`**: ÄÃ£ cÃ³ Dockerfile vÃ  Ansible inventory.

ÄÃ¢y lÃ  **bá»™ khung "xÆ°Æ¡ng sá»‘ng"** (Skeleton) vá»¯ng cháº¯c nháº¥t Ä‘á»ƒ báº¡n xÃ¢y dá»±ng há»‡ thá»‘ng Zero Trust tá»± chá»§.

---

Äá»ƒ ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ cÃ i Ä‘áº·t **Control Plane** lÃªn Ubuntu má»™t cÃ¡ch nhanh nháº¥t (thÆ°á»ng gá»i lÃ  "One-click install" hoáº·c "Zero-touch setup"), báº¡n cáº§n Ä‘Ã³ng gÃ³i quy trÃ¬nh cÃ i Ä‘áº·t vÃ o má»™t **Bash Script** duy nháº¥t.

Script nÃ y sáº½ thá»±c hiá»‡n 3 nhiá»‡m vá»¥:

1.  **CÃ i Ä‘áº·t Dependencies** (Docker, Docker Compose).
2.  **Cáº¥u hÃ¬nh MÃ´i trÆ°á»ng** (Táº¡o file `.env`, sinh máº­t kháº©u ngáº«u nhiÃªn).
3.  **Triá»ƒn khai** (Build Docker image vÃ  cháº¡y container).

DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c bÆ°á»›c thá»±c hiá»‡n chi tiáº¿t Ä‘á»ƒ tÃ­ch há»£p vÃ o repo cá»§a báº¡n.

---

### BÆ°á»›c 1: Chuáº©n bá»‹ file `docker-compose.prod.yml`

Trong thÆ° má»¥c gá»‘c cá»§a dá»± Ã¡n, báº¡n cáº§n má»™t file docker-compose dÃ nh riÃªng cho mÃ´i trÆ°á»ng Production (khÃ¡c vá»›i file dev báº¡n Ä‘ang cÃ³).

Táº¡o file `docker-compose.prod.yml`:

```yaml
version: "3.8"

services:
  # --- CONTROL PLANE API ---
  control-plane:
    container_name: zt-control-plane
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.control
    restart: always
    ports:
      - "${API_PORT:-8000}:8000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - zt-net

  # --- DATABASE ---
  db:
    container_name: zt-database
    image: postgres:15-alpine
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - zt-net

volumes:
  postgres_data:

networks:
  zt-net:
    driver: bridge
```

---

### BÆ°á»›c 2: Viáº¿t script cÃ i Ä‘áº·t `setup-control-plane.sh`

Táº¡o file `scripts/setup-control-plane.sh` (hoáº·c Ä‘á»ƒ ngay root). Script nÃ y sáº½ lÃ  thá»© duy nháº¥t ngÆ°á»i dÃ¹ng cáº§n táº£i vá» vÃ  cháº¡y.

```bash
#!/bin/bash

# ==============================================================================
# ZERO TRUST CONTROL PLANE - INSTALLER
# ==============================================================================

set -e

# --- Cáº¤U HÃŒNH ---
INSTALL_DIR="/opt/zero-trust-control-plane"
REPO_URL="https://github.com/maithanhduyan/zero-trust-netwoking.git"
BRANCH="main"

# MÃ u sáº¯c
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

log() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# Kiá»ƒm tra quyá»n Root
if [ "$EUID" -ne 0 ]; then
  error "Vui lÃ²ng cháº¡y script vá»›i quyá»n root (sudo)."
fi

# 1. CÃ i Ä‘áº·t Docker & Docker Compose (Náº¿u chÆ°a cÃ³)
install_docker() {
    if ! command -v docker &> /dev/null; then
        log "Äang cÃ i Ä‘áº·t Docker Engine..."
        curl -fsSL https://get.docker.com | sh
        success "Docker installed."
    else
        log "Docker Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t."
    fi
}

# 2. Clone hoáº·c Pull Code
setup_codebase() {
    if [ -d "$INSTALL_DIR" ]; then
        log "Cáº­p nháº­t mÃ£ nguá»“n táº¡i $INSTALL_DIR..."
        cd "$INSTALL_DIR"
        git pull origin $BRANCH
    else
        log "Clone mÃ£ nguá»“n vá» $INSTALL_DIR..."
        git clone -b $BRANCH $REPO_URL "$INSTALL_DIR"
        cd "$INSTALL_DIR"
    fi
}

# 3. Táº¡o file cáº¥u hÃ¬nh .env (Tá»± sinh máº­t kháº©u)
generate_env() {
    if [ ! -f ".env" ]; then
        log "Äang khá»Ÿi táº¡o cáº¥u hÃ¬nh .env..."

        # Sinh máº­t kháº©u ngáº«u nhiÃªn
        DB_PASSWORD=$(openssl rand -hex 16)
        SECRET_KEY=$(openssl rand -hex 32)

        cat > .env <<EOF
# --- General ---
ENV=production
SECRET_KEY=$SECRET_KEY
API_PORT=8000

# --- Database ---
DB_USER=zt_admin
DB_PASSWORD=$DB_PASSWORD
DB_NAME=zt_control_plane
EOF
        success "ÄÃ£ táº¡o file .env vá»›i máº­t kháº©u ngáº«u nhiÃªn."
    else
        log "File .env Ä‘Ã£ tá»“n táº¡i. Giá»¯ nguyÃªn cáº¥u hÃ¬nh cÅ©."
    fi
}

# 4. Cháº¡y Container
deploy() {
    log "Äang build vÃ  khá»Ÿi Ä‘á»™ng há»‡ thá»‘ng..."
    docker compose -f docker-compose.prod.yml up -d --build

    # Chá» DB khá»Ÿi Ä‘á»™ng vÃ  cháº¡y migration (náº¿u cÃ³ lá»‡nh migrate)
    # log "Äang cháº¡y Database Migrations..."
    # docker compose -f docker-compose.prod.yml exec -T control-plane python -m alembic upgrade head
}

# --- MAIN ---
echo "=================================================="
echo "   ZERO TRUST CONTROL PLANE INSTALLER"
echo "=================================================="

install_docker
setup_codebase
generate_env
deploy

echo ""
echo "=================================================="
echo -e "${GREEN}CÃ€I Äáº¶T HOÃ€N Táº¤T!${NC}"
echo "--------------------------------------------------"
echo "API Ä‘ang cháº¡y táº¡i: http://$(curl -s ifconfig.me):8000"
echo "ThÆ° má»¥c cÃ i Ä‘áº·t:   $INSTALL_DIR"
echo "Xem logs:          cd $INSTALL_DIR && docker compose -f docker-compose.prod.yml logs -f"
echo "=================================================="
```

---

### BÆ°á»›c 3: Cáº­p nháº­t README.md (Tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng)

ÄÃ¢y lÃ  bÆ°á»›c quan trá»ng nháº¥t Ä‘á»ƒ ngÆ°á»i dÃ¹ng biáº¿t cÃ¡ch cÃ i Ä‘áº·t. Báº¡n hÃ£y thÃªm Ä‘oáº¡n nÃ y vÃ o Ä‘áº§u file `README.md` trÃªn Github.

````markdown
## ğŸš€ Quick Start (Production)

CÃ i Ä‘áº·t Control Plane lÃªn Ubuntu Server chá»‰ vá»›i má»™t dÃ²ng lá»‡nh:

```bash
curl -sSL https://raw.githubusercontent.com/maithanhduyan/zero-trust-netwoking/main/scripts/setup-control-plane.sh | sudo bash
```
````

**Script nÃ y sáº½ tá»± Ä‘á»™ng:**

1. CÃ i Ä‘áº·t Docker & Docker Compose.
2. Clone mÃ£ nguá»“n vá» `/opt/zero-trust-control-plane`.
3. Tá»± Ä‘á»™ng sinh máº­t kháº©u Database an toÃ n.
4. Khá»Ÿi cháº¡y há»‡ thá»‘ng API & Database.

````

---

### BÆ°á»›c 4: Kiá»ƒm tra vÃ  Push lÃªn Github

1.  Äáº£m báº£o file script cÃ³ trong git:
    ```bash
    mkdir -p scripts
    # (LÆ°u file setup-control-plane.sh vÃ o thÆ° má»¥c scripts)
    chmod +x scripts/setup-control-plane.sh
    ```
2.  Push code lÃªn Github:
    ```bash
    git add .
    git commit -m "feat: Add production docker-compose and installer script"
    git push origin main
    ```

### Táº¡i sao cÃ¡ch nÃ y tá»‘t nháº¥t?

1.  **KhÃ´ng cáº§n hÆ°á»›ng dáº«n dÃ i dÃ²ng:** NgÆ°á»i dÃ¹ng khÃ´ng cáº§n biáº¿t `git clone`, khÃ´ng cáº§n biáº¿t sá»­a file `.env`, khÃ´ng cáº§n biáº¿t cÃ i Docker. Há» chá»‰ cáº§n `curl | bash`.
2.  **Báº£o máº­t:** Script tá»± Ä‘á»™ng sinh máº­t kháº©u máº¡nh (`openssl rand`) thay vÃ¬ dÃ¹ng máº­t kháº©u máº·c Ä‘á»‹nh "password123".
3.  **Chuáº©n hÃ³a:** Má»i server cÃ i Ä‘áº·t theo cÃ¡ch nÃ y Ä‘á»u cÃ³ cáº¥u trÃºc thÆ° má»¥c giá»‘ng há»‡t nhau (`/opt/zero-trust-control-plane`), giÃºp báº¡n dá»… dÃ ng debug hoáº·c viáº¿t tÃ i liá»‡u hÆ°á»›ng dáº«n sau nÃ y.

---

ÄÃ¢y lÃ  pháº§n triá»ƒn khai chi tiáº¿t mÃ£ nguá»“n (coding) cho **Control Plane**. ChÃºng ta sáº½ sá»­ dá»¥ng **Python (FastAPI + SQLAlchemy)** vÃ¬ tÃ­nh máº¡nh máº½, tá»‘c Ä‘á»™ cao vÃ  dá»… dÃ ng tÃ­ch há»£p vá»›i cÃ¡c logic xá»­ lÃ½ máº¡ng.

Há»‡ thá»‘ng nÃ y sáº½ thá»±c hiá»‡n 3 nhiá»‡m vá»¥ cá»‘t lÃµi cá»§a má»™t Zero Trust Controller:
1.  **IPAM (IP Address Management):** Tá»± Ä‘á»™ng cáº¥p IP trong dáº£i `10.0.0.x`.
2.  **Node Registry:** Quáº£n lÃ½ danh sÃ¡ch cÃ¡c VPS (Peers).
3.  **Policy Engine:** Sinh ra cáº¥u hÃ¬nh WireGuard vÃ  luáº­t Firewall (iptables) dá»±a trÃªn Role.

### 1. CÃ i Ä‘áº·t thÆ° viá»‡n
Táº¡o file `control-plane/requirements.txt`:

```text
fastapi==0.109.0
uvicorn==0.27.0
sqlalchemy==2.0.25
pydantic==2.5.3
pydantic-settings==2.1.0
````

### 2. Thiáº¿t káº¿ Database (LÆ°u trá»¯ tráº¡ng thÃ¡i)

Táº¡o file `control-plane/database/models.py`. ChÃºng ta dÃ¹ng SQLite cho Ä‘Æ¡n giáº£n (hoáº·c Postgres cho production) Ä‘á»ƒ lÆ°u Node.

```python
# control-plane/database/models.py
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.orm import declarative_base
from datetime import datetime

Base = declarative_base()

class Node(Base):
    __tablename__ = "nodes"

    id = Column(Integer, primary_key=True, index=True)
    hostname = Column(String, unique=True, index=True)
    role = Column(String)  # 'hub', 'app', 'db', 'ops'
    public_key = Column(String, unique=True)
    overlay_ip = Column(String, unique=True) # IP trong máº¡ng VPN (VD: 10.0.0.2)
    real_ip = Column(String, nullable=True)  # IP Public cá»§a VPS
    is_active = Column(Boolean, default=False) # Pháº£i Ä‘Æ°á»£c approve má»›i cháº¡y
    last_seen = Column(DateTime, default=datetime.utcnow)
```

Táº¡o file `control-plane/database/session.py` Ä‘á»ƒ káº¿t ná»‘i DB:

```python
# control-plane/database/session.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from .models import Base

# DÃ¹ng SQLite cho dá»… demo, Prod nÃªn dÃ¹ng PostgreSQL
SQLALCHEMY_DATABASE_URL = "sqlite:///./zerotrust.db"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False}
)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def init_db():
    Base.metadata.create_all(bind=engine)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 3. Äá»‹nh nghÄ©a Data Schema (Pydantic)

Táº¡o file `control-plane/schemas.py` Ä‘á»ƒ validate dá»¯ liá»‡u Ä‘áº§u vÃ o/ra cá»§a API.

```python
# control-plane/schemas.py
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

class NodeCreate(BaseModel):
    hostname: str
    role: str
    public_key: str

class NodeResponse(BaseModel):
    id: int
    hostname: str
    role: str
    overlay_ip: str
    is_active: bool

    class Config:
        from_attributes = True

class FirewallRule(BaseModel):
    src_ip: str
    port: int
    proto: str = "tcp"
    action: str = "ACCEPT"

class WireGuardConfig(BaseModel):
    node_ip: str
    server_public_key: str
    server_endpoint: str
    allowed_ips: str  # 10.0.0.0/24
    peers: List[dict] # Danh sÃ¡ch peer (náº¿u mesh)
    acl_rules: List[FirewallRule] # Luáº­t firewall Ä‘á»ƒ Agent apply
```

### 4. Policy Engine (Bá»™ nÃ£o Zero Trust)

ÄÃ¢y lÃ  pháº§n quan trá»ng nháº¥t. Táº¡o file `control-plane/core/policy_engine.py`.
Thay vÃ¬ lÆ°u cá»©ng trong DB, ta Ä‘á»‹nh nghÄ©a **Policy-as-Code** á»Ÿ Ä‘Ã¢y.

```python
# control-plane/core/policy_engine.py
from typing import List
from schemas import FirewallRule

# Äá»‹nh nghÄ©a luáº­t truy cáº­p (Intent-based)
# Ai (Source Role) -> ÄÆ°á»£c lÃ m gÃ¬ (Port) -> Vá»›i ai (Target Role)
POLICIES = [
    # Odoo (App) Ä‘Æ°á»£c gá»i Postgres (DB) qua port 5432
    {"src": "app", "dst": "db", "port": 5432, "proto": "tcp"},

    # Ops Ä‘Æ°á»£c SSH vÃ o táº¥t cáº£ má»i nÆ¡i
    {"src": "ops", "dst": "*", "port": 22, "proto": "tcp"},

    # Ops Ä‘Æ°á»£c truy cáº­p monitoring
    {"src": "ops", "dst": "*", "port": 9100, "proto": "tcp"},
]

def generate_acl(target_role: str, all_nodes: list) -> List[FirewallRule]:
    """
    TÃ­nh toÃ¡n danh sÃ¡ch IP Ä‘Æ°á»£c phÃ©p káº¿t ná»‘i vÃ o Node hiá»‡n táº¡i
    """
    rules = []

    for policy in POLICIES:
        # Náº¿u rule Ã¡p dá»¥ng cho role cá»§a node hiá»‡n táº¡i (hoáº·c wildcard *)
        if policy["dst"] == target_role or policy["dst"] == "*":

            # TÃ¬m táº¥t cáº£ node cÃ³ role lÃ  nguá»“n (src)
            authorized_nodes = [
                n for n in all_nodes
                if n.role == policy["src"] and n.is_active
            ]

            # Táº¡o rule cho tá»«ng IP
            for node in authorized_nodes:
                rules.append(FirewallRule(
                    src_ip=node.overlay_ip,
                    port=policy["port"],
                    proto=policy["proto"]
                ))

    return rules
```

### 5. Logic quáº£n lÃ½ Node & IPAM

Táº¡o file `control-plane/core/node_manager.py`.

```python
# control-plane/core/node_manager.py
from sqlalchemy.orm import Session
from database.models import Node
import schemas
import ipaddress

# Cáº¥u hÃ¬nh máº¡ng Overlay
NETWORK_CIDR = "10.0.0.0/24"
SERVER_IP = "10.0.0.1"
SERVER_PUBLIC_KEY = "SERVER_WG_PUBLIC_KEY_PLACEHOLDER" # Thay báº±ng key tháº­t cá»§a VPS-1
SERVER_ENDPOINT = "vps1.domain.com:51820" # Thay báº±ng IP/Domain tháº­t

def get_next_ip(db: Session):
    """Cáº¥p phÃ¡t IP tiáº¿p theo chÆ°a sá»­ dá»¥ng"""
    used_ips = [n.overlay_ip for n in db.query(Node).all()]
    network = ipaddress.IPv4Network(NETWORK_CIDR)

    # Bá» qua .0 (network), .1 (gateway/hub), .255 (broadcast)
    for ip in network.hosts():
        ip_str = str(ip)
        if ip_str == SERVER_IP: continue
        if ip_str not in used_ips:
            return ip_str
    raise Exception("Network exhausted")

def register_node(db: Session, node_in: schemas.NodeCreate):
    # Kiá»ƒm tra xem hostname hoáº·c key Ä‘Ã£ tá»“n táº¡i chÆ°a
    existing = db.query(Node).filter(
        (Node.hostname == node_in.hostname) | (Node.public_key == node_in.public_key)
    ).first()

    if existing:
        return existing

    # Cáº¥p IP má»›i
    new_ip = get_next_ip(db)

    # Máº·c Ä‘á»‹nh auto-approve cho Ops, cÃ¡c role khÃ¡c pháº£i Ä‘á»£i (hoáº·c auto cho demo)
    is_active = True

    db_node = Node(
        hostname=node_in.hostname,
        role=node_in.role,
        public_key=node_in.public_key,
        overlay_ip=new_ip,
        is_active=is_active
    )
    db.add(db_node)
    db.commit()
    db.refresh(db_node)
    return db_node
```

### 6. API Endpoints

Táº¡o file `control-plane/api.py`.

```python
# control-plane/api.py
from fastapi import FastAPI, Depends, HTTPException, Request
from sqlalchemy.orm import Session
from database import session, models
from core import node_manager, policy_engine
import schemas

# Khá»Ÿi táº¡o DB
session.init_db()

app = FastAPI(title="Zero Trust Control Plane")

@app.post("/register", response_model=schemas.NodeResponse)
def register(node: schemas.NodeCreate, db: Session = Depends(session.get_db)):
    """Agent gá»i endpoint nÃ y láº§n Ä‘áº§u Ä‘á»ƒ láº¥y Overlay IP"""
    return node_manager.register_node(db, node)

@app.get("/config/{hostname}", response_model=schemas.WireGuardConfig)
def get_config(hostname: str, request: Request, db: Session = Depends(session.get_db)):
    """
    Agent gá»i endpoint nÃ y Ä‘á»‹nh ká»³ Ä‘á»ƒ:
    1. Cáº­p nháº­t Real IP (Heartbeat)
    2. Láº¥y danh sÃ¡ch ACL má»›i nháº¥t
    """
    node = db.query(models.Node).filter(models.Node.hostname == hostname).first()
    if not node:
        raise HTTPException(status_code=404, detail="Node not found")

    if not node.is_active:
        raise HTTPException(status_code=403, detail="Node pending approval")

    # 1. Update Heartbeat & Real IP
    node.real_ip = request.client.host
    node.last_seen = datetime.utcnow()
    db.commit()

    # 2. TÃ­nh toÃ¡n ACL Rules dá»±a trÃªn Role
    all_nodes = db.query(models.Node).all()
    acl_rules = policy_engine.generate_acl(node.role, all_nodes)

    # 3. Tráº£ vá» cáº¥u hÃ¬nh
    return schemas.WireGuardConfig(
        node_ip=node.overlay_ip,
        server_public_key=node_manager.SERVER_PUBLIC_KEY,
        server_endpoint=node_manager.SERVER_ENDPOINT,
        allowed_ips="10.0.0.0/24", # Route toÃ n bá»™ VPN traffic qua Hub
        peers=[], # Trong mÃ´ hÃ¬nh Hub-and-Spoke, Agent chá»‰ cáº§n peer vá»›i Hub
        acl_rules=acl_rules
    )
```

### 7. Entry Point

Táº¡o file `control-plane/main.py`.

```python
# control-plane/main.py
import uvicorn
from api import app

if __name__ == "__main__":
    # Cháº¡y server táº¡i port 8000
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True)
```

---

### HÆ°á»›ng dáº«n cháº¡y thá»­ Control Plane

1.  **VÃ o thÆ° má»¥c:**

    ```bash
    cd control-plane
    ```

2.  **CÃ i dependencies:**

    ```bash
    pip install -r requirements.txt
    ```

3.  **Cáº¥u hÃ¬nh biáº¿n mÃ´i trÆ°á»ng:**
    Má»Ÿ `core/node_manager.py` vÃ  sá»­a `SERVER_PUBLIC_KEY` báº±ng public key WireGuard tháº­t trÃªn VPS-1 (láº¥y báº±ng lá»‡nh `wg show wg0 public-key`).

4.  **Cháº¡y server:**
    ```bash
    python3 main.py
    ```

### Kiá»ƒm thá»­ Logic Zero Trust

Giáº£ sá»­ báº¡n cÃ³ 2 node Ä‘Äƒng kÃ½: `odoo-1` (Role: app) vÃ  `postgres-1` (Role: db).

**BÆ°á»›c 1: ÄÄƒng kÃ½ Odoo**

```bash
curl -X POST http://localhost:8000/register \
-H "Content-Type: application/json" \
-d '{"hostname": "odoo-1", "role": "app", "public_key": "KEY_A..."}'
```

_Káº¿t quáº£:_ ÄÆ°á»£c cáº¥p IP `10.0.0.2`.

**BÆ°á»›c 2: ÄÄƒng kÃ½ Postgres**

```bash
curl -X POST http://localhost:8000/register \
-H "Content-Type: application/json" \
-d '{"hostname": "postgres-1", "role": "db", "public_key": "KEY_B..."}'
```

_Káº¿t quáº£:_ ÄÆ°á»£c cáº¥p IP `10.0.0.3`.

**BÆ°á»›c 3: Postgres láº¥y Config (ACL)**

```bash
curl http://localhost:8000/config/postgres-1
```

_Káº¿t quáº£ tráº£ vá» (JSON):_

```json
{
  "node_ip": "10.0.0.3",
  "acl_rules": [
    {
      "src_ip": "10.0.0.2",
      "port": 5432,
      "proto": "tcp",
      "action": "ACCEPT"
    }
  ]
}
```

**PhÃ¢n tÃ­ch:** Control Plane Ä‘Ã£ tá»± Ä‘á»™ng biáº¿t ráº±ng `postgres-1` lÃ  DB, nÃªn nÃ³ táº¡o rule cho phÃ©p `10.0.0.2` (Odoo) truy cáº­p port 5432. NÃ³ **KHÃ”NG** táº¡o rule cho phÃ©p SSH (port 22) vÃ¬ trong Policy khÃ´ng Ä‘á»‹nh nghÄ©a.

ÄÃ¢y chÃ­nh lÃ  cá»‘t lÃµi cá»§a **Dynamic Zero Trust Control Plane**: Báº¡n thay Ä‘á»•i Policy á»Ÿ server, táº¥t cáº£ firewall á»Ÿ client tá»± Ä‘á»™ng cáº­p nháº­t theo láº§n sync tiáº¿p theo.

---

Quyáº¿t Ä‘á»‹nh tuyá»‡t vá»i. `uv` (cá»§a Astral) nhanh hÆ¡n `pip` tá»« 10-100 láº§n vÃ  há»— trá»£ quáº£n lÃ½ dá»± Ã¡n (Project Management) vá»›i file `pyproject.toml` ráº¥t chuáº©n chá»‰, thay vÃ¬ dÃ¹ng `requirements.txt` rá»i ráº¡c.

Vá»›i cáº¥u trÃºc Monorepo (Control Plane + Agent), chÃºng ta sáº½ sá»­ dá»¥ng tÃ­nh nÄƒng **Workspaces** cá»§a `uv` Ä‘á»ƒ quáº£n lÃ½ cáº£ hai trong má»™t dá»± Ã¡n duy nháº¥t.

DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c bÆ°á»›c chuyá»ƒn Ä‘á»•i toÃ n bá»™ dá»± Ã¡n sang `uv`.

### 1. Cáº¥u trÃºc thÆ° má»¥c má»›i (vá»›i `uv`)

Thay vÃ¬ `requirements.txt`, chÃºng ta sáº½ cÃ³ `pyproject.toml` á»Ÿ root vÃ  tá»«ng thÆ° má»¥c con.

```text
zero-trust-networking/
â”œâ”€â”€ pyproject.toml           # (ROOT) Äá»‹nh nghÄ©a Workspace
â”œâ”€â”€ uv.lock                  # (ROOT) KhÃ³a phiÃªn báº£n cho toÃ n bá»™ dá»± Ã¡n (Báº¢O Máº¬T)
â”‚
â”œâ”€â”€ control-plane/
â”‚   â”œâ”€â”€ pyproject.toml       # Dependencies riÃªng cá»§a Control Plane
â”‚   â””â”€â”€ src/                 # (KhuyÃªn dÃ¹ng src layout cho chuáº©n)
â”‚       â””â”€â”€ main.py
â”‚
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ pyproject.toml       # Dependencies riÃªng cá»§a Agent
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ agent.py
â”‚
â””â”€â”€ infrastructure/
    â””â”€â”€ docker/
        â””â”€â”€ Dockerfile.control # Dockerfile tá»‘i Æ°u cho uv
```

---

### 2. Thiáº¿t láº­p Workspace

Báº¡n cháº¡y cÃ¡c lá»‡nh sau táº¡i thÆ° má»¥c gá»‘c cá»§a dá»± Ã¡n Ä‘á»ƒ khá»Ÿi táº¡o:

```bash
# 1. CÃ i Ä‘áº·t uv (náº¿u chÆ°a cÃ³)
curl -LsSf https://astral.sh/uv/install.sh | sh

# 2. Khá»Ÿi táº¡o dá»± Ã¡n gá»‘c
uv init --app --name zero-trust-networking
# (XÃ³a file hello.py máº·c Ä‘á»‹nh náº¿u cÃ³)

# 3. Sá»­a file pyproject.toml á»Ÿ root Ä‘á»ƒ khai bÃ¡o workspace
```

**Ná»™i dung `pyproject.toml` (Gá»‘c):**

```toml
[project]
name = "zero-trust-networking"
version = "0.1.0"
description = "Zero Trust Architecture Control Plane & Agent"
requires-python = ">=3.10"
dependencies = []

[tool.uv]
# Khai bÃ¡o cÃ¡c thÃ nh viÃªn trong workspace
members = ["control-plane", "agent"]
```

---

### 3. Cáº¥u hÃ¬nh Dependencies cho tá»«ng module

#### A. Control Plane

Thay vÃ¬ táº¡o file text, ta táº¡o `pyproject.toml` trong `control-plane/`.

**Ná»™i dung `control-plane/pyproject.toml`:**

```toml
[project]
name = "control-plane"
version = "0.1.0"
description = "The Brain of Zero Trust"
requires-python = ">=3.10"
dependencies = [
    "fastapi>=0.109.0",
    "uvicorn>=0.27.0",
    "sqlalchemy>=2.0.25",
    "pydantic>=2.5.3",
    "pydantic-settings>=2.1.0",
    "psycopg2-binary>=2.9.9",
    "alembic>=1.13.1"
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

#### B. Agent

TÆ°Æ¡ng tá»± cho Agent.

**Ná»™i dung `agent/pyproject.toml`:**

```toml
[project]
name = "zt-agent"
version = "0.1.0"
description = "The Muscle of Zero Trust"
requires-python = ">=3.10"
dependencies = [
    "requests>=2.31.0",
    "schedule>=1.2.1",
    "psutil>=5.9.8",
    "netifaces>=0.11.0"
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

---

### 4. Cáº­p nháº­t `Dockerfile` (Tá»‘i Æ°u Cache cá»±c máº¡nh)

ÄÃ¢y lÃ  nÆ¡i `uv` tá»a sÃ¡ng. ChÃºng ta sá»­ dá»¥ng **Multi-stage build** Ä‘á»ƒ cache dependencies. Docker sáº½ khÃ´ng pháº£i táº£i láº¡i thÆ° viá»‡n náº¿u code thay Ä‘á»•i, chá»‰ táº£i láº¡i khi `uv.lock` thay Ä‘á»•i.

**File: `infrastructure/docker/Dockerfile.control`**

```dockerfile
# --- STAGE 1: Builder (CÃ i Ä‘áº·t dependencies) ---
FROM ghcr.io/astral-sh/uv:python3.10-bookworm-slim AS builder

WORKDIR /app

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1
# Copy cÃ¡c file Ä‘á»‹nh nghÄ©a dependencies trÆ°á»›c
COPY pyproject.toml uv.lock ./
COPY control-plane/pyproject.toml ./control-plane/
COPY agent/pyproject.toml ./agent/

# Äá»“ng bá»™ dependencies (chÆ°a cáº§n source code)
# Lá»‡nh nÃ y sáº½ táº¡o virtualenv táº¡i .venv
RUN uv sync --frozen --no-install-project

# --- STAGE 2: Runtime (Cháº¡y á»©ng dá»¥ng) ---
FROM python:3.10-slim-bookworm

WORKDIR /app

# Copy mÃ´i trÆ°á»ng áº£o tá»« builder sang
COPY --from=builder /app/.venv /app/.venv

# Äáº·t Ä‘Æ°á»ng dáº«n Ä‘á»ƒ dÃ¹ng python trong venv máº·c Ä‘á»‹nh
ENV PATH="/app/.venv/bin:$PATH"

# Copy source code
COPY control-plane ./control-plane

# Chuyá»ƒn vÃ o thÆ° má»¥c lÃ m viá»‡c
WORKDIR /app/control-plane

# Cháº¡y server
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

### 5. Cáº­p nháº­t script `install.sh` (Cho Dev Environment)

ChÃºng ta sá»­a láº¡i script cÃ i Ä‘áº·t Ä‘á»ƒ dÃ¹ng `uv sync` thay vÃ¬ `pip install`.

```bash
#!/bin/bash

# ==============================================================================
#  ZERO TRUST PROJECT SCAFFOLDING (UV EDITION)
# ==============================================================================

set -e
PROJECT_NAME="zero-trust-networking"

# ... (Giá»¯ nguyÃªn cÃ¡c pháº§n táº¡o thÆ° má»¥c cÅ©) ...

log "0. CÃ i Ä‘áº·t uv..."
if ! command -v uv &> /dev/null; then
    curl -LsSf https://astral.sh/uv/install.sh | sh
    source $HOME/.cargo/env
fi

mkdir -p "$PROJECT_NAME"
cd "$PROJECT_NAME"

# --- Táº O FILE PYPROJECT.TOML ---
log "1. Khá»Ÿi táº¡o Workspace..."
cat > pyproject.toml <<EOF
[project]
name = "zero-trust-networking"
version = "0.1.0"
requires-python = ">=3.10"
dependencies = []

[tool.uv]
members = ["control-plane", "agent"]
EOF

# --- CONTROL PLANE SETUP ---
log "2. Setup Control Plane..."
mkdir -p control-plane
cat > control-plane/pyproject.toml <<EOF
[project]
name = "control-plane"
version = "0.1.0"
requires-python = ">=3.10"
dependencies = [
    "fastapi",
    "uvicorn",
    "sqlalchemy",
    "pydantic",
    "psycopg2-binary"
]
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
EOF

# --- AGENT SETUP ---
log "3. Setup Agent..."
mkdir -p agent
cat > agent/pyproject.toml <<EOF
[project]
name = "zt-agent"
version = "0.1.0"
requires-python = ">=3.10"
dependencies = [
    "requests",
    "schedule"
]
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
EOF

# --- CÃ€I Äáº¶T ---
log "4. Installing dependencies with uv..."
uv sync

success "HoÃ n táº¥t! MÃ´i trÆ°á»ng áº£o Ä‘Ã£ Ä‘Æ°á»£c táº¡o táº¡i .venv"
echo "Äá»ƒ kÃ­ch hoáº¡t: source .venv/bin/activate"
```

### 6. Workflow lÃ m viá»‡c hÃ ng ngÃ y (Cheat Sheet)

Khi dÃ¹ng `uv`, quy trÃ¬nh cá»§a báº¡n sáº½ nhÆ° sau:

1.  **ThÃªm thÆ° viá»‡n má»›i cho Control Plane:**

    ```bash
    # Thay vÃ¬ pip install requests
    uv add requests --package control-plane
    ```

    _Lá»‡nh nÃ y tá»± Ä‘á»™ng cáº­p nháº­t `control-plane/pyproject.toml` vÃ  `uv.lock` á»Ÿ root._

2.  **Cháº¡y Control Plane (Dev):**

    ```bash
    # KhÃ´ng cáº§n activate venv thá»§ cÃ´ng
    uv run --package control-plane uvicorn main:app --reload
    ```

3.  **Äá»“ng bá»™ mÃ´i trÆ°á»ng (khi pull code vá»):**
    ```bash
    uv sync
    ```

### Táº¡i sao thay Ä‘á»•i nÃ y quan trá»ng cho dá»± Ã¡n cá»§a báº¡n?

Vá»›i Zero Trust, **tÃ­nh nháº¥t quÃ¡n (Consistency)** lÃ  quan trá»ng nháº¥t.

- `pip` khÃ´ng cÃ³ lockfile máº·c Ä‘á»‹nh -> Má»—i láº§n cÃ i trÃªn VPS khÃ¡c nhau cÃ³ thá»ƒ ra phiÃªn báº£n phá»¥ khÃ¡c nhau -> Bug tiá»m áº©n.
- `uv.lock` Ä‘áº£m báº£o VPS 1, VPS 4 vÃ  MÃ¡y Dev cá»§a báº¡n cháº¡y **chÃ­nh xÃ¡c tá»«ng byte** cá»§a cÃ¹ng má»™t phiÃªn báº£n thÆ° viá»‡n.

---

**Cáº§n má»Ÿ port 8000 trÃªn control-plane container Ä‘á»ƒ truy cáº­p API?**

CÃ¢u tráº£ lá»i ngáº¯n gá»n: **CÃ“**, Agent cáº§n má»™t Ä‘Æ°á»ng Ä‘á»ƒ "gá»i" vá» Control Plane láº¥y cáº¥u hÃ¬nh. **NHÆ¯NG**, báº¡n **TUYá»†T Äá»I KHÃ”NG** nÃªn má»Ÿ port 8000 (HTTP) tráº§n trá»¥i ra Internet. LÃ m váº­y lÃ  "má»i" hacker vÃ o nhÃ .

DÆ°á»›i Ä‘Ã¢y lÃ  3 cáº¥p Ä‘á»™ báº£o máº­t cho viá»‡c nÃ y, Ä‘i tá»« cÆ¡ báº£n Ä‘áº¿n chuáº©n Zero Trust:

### Cáº¥p Ä‘á»™ 1: CÆ¡ báº£n (Reverse Proxy + SSL) - Báº¯t buá»™c tá»‘i thiá»ƒu

KhÃ´ng bao giá» expose Uvicorn/FastAPI trá»±c tiáº¿p. HÃ£y dÃ¹ng **Nginx** hoáº·c **Caddy** Ä‘á»©ng trÆ°á»›c lÃ m lÃ­nh gÃ¡c cá»•ng.

1.  **Control Plane:** Chá»‰ láº¯ng nghe á»Ÿ `localhost` (127.0.0.1:8000).
2.  **Nginx:** Má»Ÿ port **443 (HTTPS)**, nháº­n request tá»« Agent, mÃ£ hÃ³a SSL, rá»“i chuyá»ƒn tiáº¿p vÃ o port 8000 bÃªn trong.
3.  **Firewall (UFW):** Chá»‰ má»Ÿ port 443 vÃ  51820 (UDP - WireGuard), Ä‘Ã³ng cháº·t port 8000.

**Táº¡i sao?**

- MÃ£ hÃ³a dá»¯ liá»‡u config (chá»©a Private Key) trÃªn Ä‘Æ°á»ng truyá»n.
- Chá»‘ng táº¥n cÃ´ng DDoS vÃ  Slowloris tá»‘t hÆ¡n Python.

### Cáº¥p Ä‘á»™ 2: Kiáº¿n trÃºc "Trong - NgoÃ i" (Chuáº©n Zero Trust)

ÄÃ¢y lÃ  cÃ¡ch thiáº¿t káº¿ tinh táº¿ Ä‘á»ƒ giáº£i quyáº¿t bÃ i toÃ¡n "Con gÃ  - Quáº£ trá»©ng" (Agent cáº§n VPN Ä‘á»ƒ gáº·p Control Plane, nhÆ°ng cáº§n Control Plane Ä‘á»ƒ cÃ³ VPN).

ChÃºng ta chia viá»‡c giao tiáº¿p lÃ m 2 giai Ä‘oáº¡n:

#### Giai Ä‘oáº¡n 1: Bootstrap (ÄÄƒng kÃ½ láº§n Ä‘áº§u)

- **KÃªnh:** Internet cÃ´ng cá»™ng (HTTPS 443).
- **Má»¥c Ä‘Ã­ch:** Agent chÆ°a cÃ³ VPN, nÃ³ gá»i API `/register` Ä‘á»ƒ xin gia nháº­p.
- **Báº£o máº­t:** DÃ¹ng "Pre-shared Token" (Má»™t chuá»—i bÃ­ máº­t báº¡n cÃ i sáºµn vÃ o file `install.sh` cá»§a Agent).

#### Giai Ä‘oáº¡n 2: Operation (Váº­n hÃ nh & Láº¥y Config)

- **KÃªnh:** Máº¡ng VPN ná»™i bá»™ (`10.0.0.1:8000`).
- **Má»¥c Ä‘Ã­ch:** Sau khi Agent Ä‘Ã£ cÃ³ WireGuard, má»i giao tiáº¿p láº¥y config (`/sync`), gá»­i heartbeat (`/heartbeat`) sáº½ Ä‘i qua Ä‘Æ°á»ng háº§m VPN.
- **Cáº¥u hÃ¬nh:**
  - TrÃªn Control Plane, báº¡n cáº¥u hÃ¬nh Nginx hoáº·c Uvicorn Ä‘á»ƒ **chá»‰ cháº¥p nháº­n** cÃ¡c API nháº¡y cáº£m (nhÆ° láº¥y danh sÃ¡ch Peers) náº¿u request Ä‘áº¿n tá»« dáº£i IP `10.0.0.x`.

---

### HÆ°á»›ng dáº«n triá»ƒn khai (Cáº¥p Ä‘á»™ 1 + 2)

#### 1. Sá»­a `docker-compose.prod.yml`

KhÃ´ng expose port 8000 ra ngoÃ i host ná»¯a, chá»‰ Ä‘á»ƒ ná»™i bá»™ Docker network hoáº·c bind vÃ o localhost.

```yaml
control-plane:
  # ...
  ports:
    - "127.0.0.1:8000:8000" # Chá»‰ localhost cá»§a VPS má»›i gá»i Ä‘Æ°á»£c
```

#### 2. CÃ i Ä‘áº·t Caddy (Thay tháº¿ Nginx cho gá»n)

Caddy tá»± Ä‘á»™ng xin chá»©ng chá»‰ HTTPS (Let's Encrypt).

Táº¡o file `Caddyfile` táº¡i thÆ° má»¥c gá»‘c:

```text
# Thay báº±ng domain tháº­t hoáº·c IP cá»§a báº¡n
control-plane.example.com {
    # Chuyá»ƒn tiáº¿p request vÃ o container
    reverse_proxy localhost:8000

    # Báº£o máº­t thÃªm: Chá»‰ cho phÃ©p dáº£i IP ná»™i bá»™ gá»i API config (Optional)
    # @internal {
    #     remote_ip 10.0.0.0/24
    #     path /api/v1/agent/config
    # }
    # handle @internal {
    #     reverse_proxy localhost:8000
    # }
}
```

#### 3. Cáº­p nháº­t `agent/client.py`

Agent cáº§n biáº¿t 2 Ä‘á»‹a chá»‰:

1.  `PUBLIC_ENDPOINT`: `https://control-plane.example.com` (DÃ¹ng Ä‘á»ƒ Ä‘Äƒng kÃ½).
2.  `PRIVATE_ENDPOINT`: `http://10.0.0.1:8000` (DÃ¹ng sau khi WireGuard Ä‘Ã£ UP).

Trong code Agent:

```python
# agent/client.py

def get_base_url():
    # Kiá»ƒm tra xem giao diá»‡n wg0 cÃ³ IP chÆ°a
    if has_interface("wg0"):
        return "http://10.0.0.1:8000" # Äi Ä‘Æ°á»ng háº§m (An toÃ n tuyá»‡t Ä‘á»‘i)
    else:
        return "https://public-ip-vps-1.com" # Äi Ä‘Æ°á»ng Internet (MÃ£ hÃ³a SSL)
```

### TÃ³m láº¡i

1.  **KhÃ´ng má»Ÿ port 8000** ra public.
2.  **Má»Ÿ port 443** (HTTPS) dÃ¹ng Reverse Proxy Ä‘á»ƒ há»©ng request ban Ä‘áº§u.
3.  **Má»Ÿ port 51820** (UDP) Ä‘á»ƒ thiáº¿t láº­p Ä‘Æ°á»ng háº§m WireGuard.
4.  Sau khi káº¿t ná»‘i thÃ nh cÃ´ng, Æ°u tiÃªn giao tiáº¿p qua IP ná»™i bá»™ `10.0.0.1`.

---

**so sÃ¡nh nginx vs caddy vs traefik cÃ³ nÃ o hay hÆ¡n?**
CÃ¢u há»i nÃ y ráº¥t hay vÃ  thá»±c táº¿. Trong giá»›i DevOps, khÃ´ng cÃ³ cÃ¡i nÃ o lÃ  "nháº¥t" tuyá»‡t Ä‘á»‘i, mÃ  chá»‰ cÃ³ cÃ¡i **phÃ¹ há»£p nháº¥t vá»›i bÃ i toÃ¡n cá»§a báº¡n**.

DÆ°á»›i Ä‘Ã¢y lÃ  báº£ng so sÃ¡nh chi tiáº¿t vÃ  lá»i khuyÃªn cá»¥ thá»ƒ cho dá»± Ã¡n **Zero Trust Control Plane** cá»§a báº¡n.

---

### 1. Báº£ng so sÃ¡nh nhanh

| TiÃªu chÃ­        | **Nginx**                             | **Caddy**                                  | **Traefik**                    |
| :-------------- | :------------------------------------ | :----------------------------------------- | :----------------------------- |
| **Biá»‡t danh**   | "LÃ£o lÃ ng" (The Legend)               | "Hiá»‡n Ä‘áº¡i & Tá»± Ä‘á»™ng"                       | "Cloud Native"                 |
| **NgÃ´n ngá»¯**    | C (SiÃªu nhanh)                        | Go (An toÃ n, Dá»… dÃ¹ng)                      | Go (Linh hoáº¡t)                 |
| **Cáº¥u hÃ¬nh**    | Phá»©c táº¡p, dÃ i dÃ²ng.                   | Cá»±c ká»³ Ä‘Æ¡n giáº£n (`Caddyfile`).             | Dá»±a trÃªn Labels (Docker/K8s).  |
| **HTTPS/SSL**   | Pháº£i cÃ i thÃªm Certbot/Lego.           | **Tá»± Ä‘á»™ng 100%** (Máº·c Ä‘á»‹nh).               | Tá»± Ä‘á»™ng (Cáº¥u hÃ¬nh ACME).       |
| **Docker**      | TÄ©nh (Cáº§n reload khi thÃªm container). | Tá»‘t.                                       | **Xuáº¥t sáº¯c** (Auto-discovery). |
| **Hiá»‡u nÄƒng**   | Cao nháº¥t (Xá»­ lÃ½ hÃ ng triá»‡u req/s).    | Ráº¥t tá»‘t (Äá»§ cho 99% nhu cáº§u).              | Ráº¥t tá»‘t.                       |
| **PhÃ¹ há»£p cho** | Há»‡ thá»‘ng cá»±c lá»›n, Static file, Cache. | **Dev, Small/Medium Server, API Gateway.** | Microservices, Kubernetes.     |

---

### 2. PhÃ¢n tÃ­ch chi tiáº¿t

#### A. Nginx: "Ã”ng vua tá»‘c Ä‘á»™"

- **Æ¯u Ä‘iá»ƒm:**
  - Hiá»‡u nÄƒng vÃ´ Ä‘á»‘i. TÃ i nguyÃªn tiÃªu thá»¥ cá»±c tháº¥p (RAM/CPU).
  - Cá»™ng Ä‘á»“ng lá»›n nháº¥t, tÃ i liá»‡u gÃ¬ cÅ©ng cÃ³.
  - TÃ­nh nÄƒng Cache (caching) vÃ  Load Balancing ráº¥t máº¡nh.
- **NhÆ°á»£c Ä‘iá»ƒm:**
  - Cáº¥u hÃ¬nh (Config) khÃ³ nhá»›, dá»… sai cÃº phÃ¡p.
  - **KhÃ´ng tá»± Ä‘á»™ng SSL:** Báº¡n pháº£i cÃ i thÃªm `certbot`, setup cronjob Ä‘á»ƒ gia háº¡n chá»©ng chá»‰. Náº¿u quÃªn -> Sáº­p web.
- **Khi nÃ o dÃ¹ng?** Khi báº¡n váº­n hÃ nh há»‡ thá»‘ng Facebook/Google thu nhá», hoáº·c chá»‰ phá»¥c vá»¥ file tÄ©nh (áº£nh, video) vá»›i cÆ°á»ng Ä‘á»™ cao.

#### B. Traefik: "Sinh ra cho Docker & Kubernetes"

- **Æ¯u Ä‘iá»ƒm:**
  - **Auto Discovery:** Báº¡n khÃ´ng cáº§n viáº¿t file config cho tá»«ng site. Báº¡n chá»‰ cáº§n gáº¯n `labels` vÃ o Docker Container, Traefik sáº½ tá»± Ä‘á»™ng nháº­n diá»‡n vÃ  Ä‘á»‹nh tuyáº¿n.
  - CÃ³ Dashboard giao diá»‡n web ráº¥t Ä‘áº¹p Ä‘á»ƒ theo dÃµi.
  - Middleware máº¡nh máº½ (Rate limit, Basic Auth, Retry).
- **NhÆ°á»£c Ä‘iá»ƒm:**
  - Learning curve (Ä‘Æ°á»ng cong há»c táº­p) hÆ¡i cao lÃºc Ä‘áº§u. Cáº§n hiá»ƒu khÃ¡i niá»‡m `Router`, `Service`, `Middleware`.
- **Khi nÃ o dÃ¹ng?** Khi báº¡n cÃ³ 50 cÃ¡i microservices cháº¡y trÃªn Docker/K8s vÃ  chÃºng thay Ä‘á»•i liÃªn tá»¥c.

#### C. Caddy: "ÄÆ¡n giáº£n lÃ  sá»©c máº¡nh" (The Modern Way)

- **Æ¯u Ä‘iá»ƒm:**
  - **Automatic HTTPS:** ÄÃ¢y lÃ  tÃ­nh nÄƒng "Äƒn tiá»n" nháº¥t. Caddy tá»± Ä‘á»™ng xin chá»©ng chá»‰ Let's Encrypt, tá»± Ä‘á»™ng gia háº¡n. Báº¡n khÃ´ng cáº§n lÃ m gÃ¬ cáº£.
  - **HTTP/3 (QUIC):** Há»— trá»£ máº·c Ä‘á»‹nh giao thá»©c má»›i nháº¥t, giÃºp web cháº¡y nhanh hÆ¡n trÃªn máº¡ng yáº¿u.
  - **Cáº¥u hÃ¬nh siÃªu ngáº¯n:** 1 dÃ²ng config cá»§a Caddy báº±ng 10 dÃ²ng cá»§a Nginx.
- **NhÆ°á»£c Ä‘iá»ƒm:**
  - Hiá»‡u nÄƒng tháº¥p hÆ¡n Nginx má»™t chÃºt xÃ­u (nhÆ°ng vá»›i dá»± Ã¡n quáº£n lÃ½ vÃ i nghÃ¬n node thÃ¬ khÃ´ng nháº­n ra Ä‘Æ°á»£c).
- **Khi nÃ o dÃ¹ng?** Khi báº¡n muá»‘n dá»±ng server nhanh, an toÃ n máº·c Ä‘á»‹nh, khÃ´ng muá»‘n Ä‘au Ä‘áº§u quáº£n lÃ½ SSL.

---

### 3. Lá»i khuyÃªn cho dá»± Ã¡n "Zero Trust Networking"

Vá»›i dá»± Ã¡n cá»§a báº¡n (Control Plane API + Agent), tÃ´i khuyÃªn dÃ¹ng **Caddy**.

**LÃ½ do:**

1.  **Báº£o máº­t máº·c Ä‘á»‹nh:** Báº¡n cáº§n Control Plane pháº£i cháº¡y HTTPS (Ä‘á»ƒ báº£o vá»‡ Key WireGuard). Vá»›i Nginx, báº¡n pháº£i hÆ°á»›ng dáº«n ngÆ°á»i dÃ¹ng cháº¡y `certbot`, má»Ÿ port 80 Ä‘á»ƒ verify... ráº¥t phiá»n phá»©c. Vá»›i Caddy, ngÆ°á»i dÃ¹ng chá»‰ cáº§n trá» domain vá» IP, Caddy lo háº¿t pháº§n cÃ²n láº¡i.
2.  **Dá»… tÃ­ch há»£p vÃ o `docker-compose`:** Cáº¥u hÃ¬nh cá»±c gá»n.
3.  **Zero Touch:** ÄÃºng tinh tháº§n cá»§a dá»± Ã¡n.

#### So sÃ¡nh cáº¥u hÃ¬nh thá»±c táº¿ (Reverse Proxy cho API port 8000)

**Cáº¥u hÃ¬nh Nginx (Pháº£i dÃ i tháº¿ nÃ y + CÃ i Certbot):**

```nginx
server {
    listen 80;
    server_name control.example.com;
    return 301 https://$host$request_uri;
}
server {
    listen 443 ssl;
    server_name control.example.com;
    ssl_certificate /etc/letsencrypt/live/.../fullchain.pem; # Pháº£i cÃ³ file nÃ y trÆ°á»›c
    ssl_certificate_key /etc/letsencrypt/live/.../privkey.pem;

    location / {
        proxy_pass http://control-plane:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**Cáº¥u hÃ¬nh Caddy (Chá»‰ cáº§n tháº¿ nÃ y):**

```text
control.example.com {
    reverse_proxy control-plane:8000
}
```

_Caddy tá»± Ä‘á»™ng lÃ m: Má»Ÿ port 80/443, xin chá»©ng chá»‰ SSL, redirect HTTP->HTTPS, proxy pass._

### Káº¿t luáº­n

- Chá»n **Caddy** cho dá»± Ã¡n nÃ y Ä‘á»ƒ tá»‘i Æ°u tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng (Developer Experience).
- Chá»n **Traefik** náº¿u sau nÃ y báº¡n má»Ÿ rá»™ng Control Plane thÃ nh hÃ ng chá»¥c microservices phá»©c táº¡p.
- Chá»n **Nginx** náº¿u Control Plane chá»‹u táº£i hÃ ng triá»‡u request/giÃ¢y (Ä‘iá»u khÃ³ xáº£y ra vá»›i ná»™i bá»™ doanh nghiá»‡p).

---

**Pháº£i dÃ¹ng biáº¿n mÃ´i trÆ°á»ng cáº¥u hÃ¬nh chÃ¬nh caddyfile?**

---

CÃ¢u tráº£ lá»i lÃ : **Ráº¥t nÃªn dÃ¹ng, nhÆ°ng khÃ´ng báº¯t buá»™c.**

Tuy nhiÃªn, vá»›i má»¥c tiÃªu **"One-click install"** vÃ  **"Zero-touch"** mÃ  báº¡n Ä‘ang hÆ°á»›ng tá»›i, viá»‡c sá»­ dá»¥ng biáº¿n mÃ´i trÆ°á»ng trong Caddyfile lÃ  **Báº®T BUá»˜C** Ä‘á»ƒ ngÆ°á»i dÃ¹ng khÃ´ng pháº£i má»Ÿ file ra sá»­a thá»§ cÃ´ng.

DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡ch triá»ƒn khai chuáº©n nháº¥t:

### 1. Táº¡i sao pháº£i dÃ¹ng biáº¿n mÃ´i trÆ°á»ng?

- **Hardcoded (Cá»‘ Ä‘á»‹nh - KhÃ´ng nÃªn):**
  Báº¡n viáº¿t `control.example.com` vÃ o `Caddyfile`. Khi ngÆ°á»i dÃ¹ng táº£i vá», há» pháº£i má»Ÿ file Ä‘Ã³ ra, sá»­a thÃ nh domain cá»§a há». -> **Máº¥t tÃ­nh tá»± Ä‘á»™ng.**
- **Environment Variable (Biáº¿n mÃ´i trÆ°á»ng - NÃªn dÃ¹ng):**
  Báº¡n viáº¿t `{$DOMAIN_NAME}` vÃ o `Caddyfile`. Script cÃ i Ä‘áº·t (`setup.sh`) sáº½ há»i ngÆ°á»i dÃ¹ng domain lÃ  gÃ¬, lÆ°u vÃ o file `.env`. Caddy tá»± Ä‘á»™ng Ä‘á»c vÃ  cháº¡y. -> **ChuyÃªn nghiá»‡p.**

---

### 2. CÃ¡ch cáº¥u hÃ¬nh chi tiáº¿t

#### BÆ°á»›c 1: Sá»­a file `Caddyfile`

Caddy há»— trá»£ cÃº phÃ¡p `{$TEN_BIEN}` Ä‘á»ƒ thay tháº¿ giÃ¡ trá»‹ ngay lÃºc khá»Ÿi Ä‘á»™ng.

```caddyfile
# Caddyfile

# Khá»‘i cáº¥u hÃ¬nh toÃ n cá»¥c (Global options)
{
    # Email Ä‘á»ƒ nháº­n thÃ´ng bÃ¡o tá»« Let's Encrypt (Quan trá»ng Ä‘á»ƒ khÃ´ng bá»‹ rate limit)
    email {$ACME_EMAIL}
}

# Cáº¥u hÃ¬nh Site
{$DOMAIN_NAME} {
    # Chuyá»ƒn tiáº¿p request vÃ o container control-plane
    reverse_proxy control-plane:{$API_PORT}

    # Log ra Ä‘á»‹nh dáº¡ng JSON Ä‘á»ƒ dá»… Ä‘áº©y vÃ o há»‡ thá»‘ng monitoring sau nÃ y
    log {
        output stdout
        format json
    }
}
```

#### BÆ°á»›c 2: Sá»­a `docker-compose.prod.yml`

Báº¡n cáº§n truyá»n biáº¿n tá»« file `.env` cá»§a Docker Compose vÃ o trong container Caddy.

```yaml
version: "3.8"

services:
  caddy:
    image: caddy:2.7-alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    environment:
      # Truyá»n biáº¿n vÃ o container
      - DOMAIN_NAME=${DOMAIN_NAME}
      - ACME_EMAIL=${ACME_EMAIL}
      - API_PORT=${API_PORT:-8000}
    depends_on:
      - control-plane

  # ... cÃ¡c service khÃ¡c
```

#### BÆ°á»›c 3: Cáº­p nháº­t script `setup-control-plane.sh`

Cáº­p nháº­t hÃ m `generate_env` Ä‘á»ƒ há»i ngÆ°á»i dÃ¹ng Domain vÃ  Email.

```bash
generate_env() {
    if [ ! -f ".env" ]; then
        log "Äang khá»Ÿi táº¡o cáº¥u hÃ¬nh .env..."

        # Há»i ngÆ°á»i dÃ¹ng nháº­p Domain (Náº¿u khÃ´ng nháº­p thÃ¬ dÃ¹ng IP public)
        PUBLIC_IP=$(curl -s ifconfig.me)
        read -p "Nháº­p Domain cá»§a báº¡n (Äá»ƒ trá»‘ng sáº½ dÃ¹ng IP $PUBLIC_IP): " USER_DOMAIN
        DOMAIN_NAME=${USER_DOMAIN:-$PUBLIC_IP}

        read -p "Nháº­p Email (Ä‘á»ƒ Ä‘Äƒng kÃ½ SSL): " USER_EMAIL
        ACME_EMAIL=${USER_EMAIL:-"admin@localhost"}

        # Sinh máº­t kháº©u
        DB_PASSWORD=$(openssl rand -hex 16)
        SECRET_KEY=$(openssl rand -hex 32)

        cat > .env <<EOF
# --- General ---
ENV=production
SECRET_KEY=$SECRET_KEY
API_PORT=8000

# --- Caddy / Public Access ---
DOMAIN_NAME=$DOMAIN_NAME
ACME_EMAIL=$ACME_EMAIL

# --- Database ---
DB_USER=zt_admin
DB_PASSWORD=$DB_PASSWORD
DB_NAME=zt_control_plane
EOF
        success "ÄÃ£ táº¡o file .env vá»›i domain: $DOMAIN_NAME"
    else
        log "File .env Ä‘Ã£ tá»“n táº¡i."
    fi
}
```

### 3. LÆ°u Ã½ quan trá»ng khi dÃ¹ng IP thay vÃ¬ Domain

Náº¿u ngÆ°á»i dÃ¹ng **khÃ´ng cÃ³ Domain** mÃ  chá»‰ dÃ¹ng **IP Public** (vÃ­ dá»¥ `1.2.3.4`):

1.  Caddy sáº½ **Tá»° Äá»˜NG** táº¯t cháº¿ Ä‘á»™ xin chá»©ng chá»‰ SSL tá»« Let's Encrypt (vÃ¬ Let's Encrypt khÃ´ng cáº¥p SSL cho IP public dá»… dÃ ng).
2.  Caddy sáº½ tá»± chuyá»ƒn sang dÃ¹ng **Internal Self-Signed Certificate** hoáº·c cháº¡y HTTP thÆ°á»ng (tÃ¹y cáº¥u hÃ¬nh).
3.  Äá»ƒ Ã©p Caddy cháº¡y HTTP (náº¿u chá»‰ test IP), báº¡n cÃ³ thá»ƒ dÃ¹ng cáº¥u hÃ¬nh Ä‘iá»u kiá»‡n, nhÆ°ng Ä‘Æ¡n giáº£n nháº¥t lÃ  Ä‘á»ƒ Caddy tá»± quyáº¿t Ä‘á»‹nh (Auto HTTPS).

### TÃ³m láº¡i

## Báº¡n **pháº£i** dÃ¹ng biáº¿n mÃ´i trÆ°á»ng `{$DOMAIN_NAME}` trong Caddyfile Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c má»¥c tiÃªu "One-click install". Náº¿u khÃ´ng, user sáº½ pháº£i sá»­a file báº±ng tay, ráº¥t dá»… gÃ¢y lá»—i cÃº phÃ¡p.

**Ä‘á»“i setup-control-plane.sh thÃ nh install.sh viáº¿t láº¡i tá»« Ä‘áº§u. Tá»« lÃºc kiá»ƒm tra mÃ´i trÆ°á»ng, pull git, Ä‘áº¿n táº¡o .env**

---

DÆ°á»›i Ä‘Ã¢y lÃ  file `install.sh` Ä‘Æ°á»£c viáº¿t láº¡i hoÃ n toÃ n má»›i, tá»‘i Æ°u cho tráº£i nghiá»‡m **"Zero Touch"**. Script nÃ y xá»­ lÃ½ toÃ n bá»™ vÃ²ng Ä‘á»i tá»« lÃºc mÃ¡y chá»§ "tráº¯ng tinh" cho Ä‘áº¿n khi Control Plane cháº¡y hoÃ n chá»‰nh.

### CÃ¡c tÃ­nh nÄƒng chÃ­nh:

1.  **Idempotent:** Cháº¡y láº¡i nhiá»u láº§n khÃ´ng lá»—i (tá»± Ä‘á»™ng `git pull` náº¿u code Ä‘Ã£ cÃ³).
2.  **Smart Config:** Tá»± Ä‘á»™ng phÃ¡t hiá»‡n IP Public, tá»± sinh máº­t kháº©u máº¡nh.
3.  **Auto SSL:** TÃ­ch há»£p cáº¥u hÃ¬nh cho Caddy (Domain/Email).
4.  **Dependency Management:** Tá»± cÃ i Docker/Git náº¿u thiáº¿u.

---

### Ná»™i dung file `install.sh`

```bash
#!/bin/bash

# ==============================================================================
#  ZERO TRUST CONTROL PLANE - AUTOMATED INSTALLER
#  Repository: https://github.com/maithanhduyan/zero-trust-netwoking
# ==============================================================================

set -e  # Dá»«ng ngay náº¿u cÃ³ lá»—i xáº£y ra

# --- Cáº¤U HÃŒNH Máº¶C Äá»ŠNH ---
INSTALL_DIR="/opt/zero-trust-control-plane"
REPO_URL="https://github.com/maithanhduyan/zero-trust-netwoking.git"
BRANCH="main"
COMPOSE_FILE="docker-compose.prod.yml"

# --- MÃ€U Sáº®C ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# --- HÃ€M Há»– TRá»¢ ---
log() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# --- 1. KIá»‚M TRA MÃ”I TRÆ¯á»œNG ---
check_environment() {
    log "1. Kiá»ƒm tra mÃ´i trÆ°á»ng..."

    # Kiá»ƒm tra quyá»n Root
    if [ "$EUID" -ne 0 ]; then
        error "Script nÃ y cáº§n quyá»n root. Vui lÃ²ng cháº¡y vá»›i 'sudo'."
    fi

    # Kiá»ƒm tra OS (Khuyáº¿n nghá»‹ Ubuntu/Debian)
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        if [[ "$ID" != "ubuntu" && "$ID" != "debian" ]]; then
            warn "Há»‡ Ä‘iá»u hÃ nh hiá»‡n táº¡i ($ID) chÆ°a Ä‘Æ°á»£c kiá»ƒm thá»­ ká»¹. Khuyáº¿n nghá»‹ Ubuntu LTS."
            sleep 3
        fi
    fi

    # CÃ i Ä‘áº·t cÃ¡c gÃ³i cÆ¡ báº£n cáº§n thiáº¿t
    apt-get update -qq >/dev/null 2>&1
    apt-get install -y curl git openssl >/dev/null 2>&1
    success "MÃ´i trÆ°á»ng Ä‘Ã£ sáºµn sÃ ng."
}

# --- 2. CÃ€I Äáº¶T DOCKER ---
install_docker() {
    log "2. Kiá»ƒm tra Docker..."

    if ! command -v docker &> /dev/null; then
        warn "Docker chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t. Äang tiáº¿n hÃ nh cÃ i Ä‘áº·t tá»± Ä‘á»™ng..."
        curl -fsSL https://get.docker.com | sh
        success "Docker Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t thÃ nh cÃ´ng."
    else
        success "Docker Ä‘Ã£ tá»“n táº¡i: $(docker --version)"
    fi
}

# --- 3. Táº¢I / Cáº¬P NHáº¬T MÃƒ NGUá»’N ---
setup_repository() {
    log "3. Thiáº¿t láº­p mÃ£ nguá»“n..."

    if [ -d "$INSTALL_DIR/.git" ]; then
        log "ThÆ° má»¥c cÃ i Ä‘áº·t Ä‘Ã£ tá»“n táº¡i. Äang cáº­p nháº­t code má»›i nháº¥t..."
        cd "$INSTALL_DIR"
        git fetch origin
        git reset --hard "origin/$BRANCH"
        success "ÄÃ£ cáº­p nháº­t mÃ£ nguá»“n."
    elif [ -d "$INSTALL_DIR" ]; then
        error "ThÆ° má»¥c $INSTALL_DIR Ä‘Ã£ tá»“n táº¡i nhÆ°ng khÃ´ng pháº£i Git repo. Vui lÃ²ng xÃ³a thá»§ cÃ´ng hoáº·c backup."
    else
        log "Äang clone repository vá» $INSTALL_DIR..."
        git clone -b "$BRANCH" "$REPO_URL" "$INSTALL_DIR"
        cd "$INSTALL_DIR"
        success "ÄÃ£ clone mÃ£ nguá»“n thÃ nh cÃ´ng."
    fi
}

# --- 4. Cáº¤U HÃŒNH MÃ”I TRÆ¯á»œNG (.env) ---
configure_env() {
    log "4. Cáº¥u hÃ¬nh biáº¿n mÃ´i trÆ°á»ng..."

    if [ -f ".env" ]; then
        warn "File .env Ä‘Ã£ tá»“n táº¡i. Sáº½ giá»¯ nguyÃªn cáº¥u hÃ¬nh cÅ©."
        return
    fi

    echo "--------------------------------------------------"
    echo "Há»‡ thá»‘ng cáº§n má»™t sá»‘ thÃ´ng tin Ä‘á»ƒ thiáº¿t láº­p HTTPS."
    echo "--------------------------------------------------"

    # Láº¥y IP Public tá»± Ä‘á»™ng
    PUBLIC_IP=$(curl -s ifconfig.me || echo "127.0.0.1")

    # Há»i Domain
    read -p "Nháº­p Domain cá»§a báº¡n (Nháº¥n Enter Ä‘á»ƒ dÃ¹ng IP $PUBLIC_IP): " INPUT_DOMAIN
    DOMAIN_NAME=${INPUT_DOMAIN:-$PUBLIC_IP}

    # Há»i Email (Cáº§n cho Let's Encrypt)
    read -p "Nháº­p Email quáº£n trá»‹ (Ä‘á»ƒ Ä‘Äƒng kÃ½ SSL): " INPUT_EMAIL
    ACME_EMAIL=${INPUT_EMAIL:-"admin@localhost"}

    # Sinh máº­t kháº©u ngáº«u nhiÃªn
    log "Äang sinh máº­t kháº©u an toÃ n..."
    DB_PASSWORD=$(openssl rand -hex 16)
    SECRET_KEY=$(openssl rand -hex 32)

    # Ghi file .env
    cat > .env <<EOF
# --- General Config ---
ENV=production
API_PORT=8000
SECRET_KEY=$SECRET_KEY

# --- Caddy / SSL Config ---
DOMAIN_NAME=$DOMAIN_NAME
ACME_EMAIL=$ACME_EMAIL

# --- Database Config ---
DB_HOST=db
DB_PORT=5432
DB_USER=zt_admin
DB_PASSWORD=$DB_PASSWORD
DB_NAME=zt_control_plane
EOF

    success "ÄÃ£ táº¡o file .env má»›i."
}

# --- 5. TRIá»‚N KHAI (DOCKER COMPOSE) ---
deploy_containers() {
    log "5. Triá»ƒn khai Control Plane..."

    cd "$INSTALL_DIR"

    # Kiá»ƒm tra xem file docker-compose production cÃ³ tá»“n táº¡i khÃ´ng
    if [ ! -f "$COMPOSE_FILE" ]; then
        error "KhÃ´ng tÃ¬m tháº¥y file $COMPOSE_FILE. Repo cÃ³ thá»ƒ bá»‹ lá»—i."
    fi

    log "Äang build vÃ  khá»Ÿi Ä‘á»™ng Containers (QuÃ¡ trÃ¬nh nÃ y cÃ³ thá»ƒ máº¥t vÃ i phÃºt)..."

    # Táº¯t version cÅ© náº¿u Ä‘ang cháº¡y
    docker compose -f "$COMPOSE_FILE" down --remove-orphans >/dev/null 2>&1 || true

    # Cháº¡y version má»›i
    if docker compose -f "$COMPOSE_FILE" up -d --build; then
        success "Containers Ä‘Ã£ khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng."
    else
        error "Lá»—i khi khá»Ÿi Ä‘á»™ng Docker Compose."
    fi
}

# --- 6. Tá»”NG Káº¾T ---
show_summary() {
    # Láº¥y thÃ´ng tin tá»« .env
    source .env

    echo ""
    echo "=================================================="
    echo -e "${GREEN}   CÃ€I Äáº¶T CONTROL PLANE HOÃ€N Táº¤T! ${NC}"
    echo "=================================================="
    echo -e "ğŸ“‚ ThÆ° má»¥c cÃ i Ä‘áº·t:  ${YELLOW}$INSTALL_DIR${NC}"
    echo -e "ğŸŒ Äá»‹a chá»‰ truy cáº­p: ${YELLOW}https://$DOMAIN_NAME${NC} (hoáº·c http náº¿u dÃ¹ng IP)"
    echo -e "ğŸ”‘ Database User:    ${YELLOW}$DB_USER${NC}"
    echo -e "ğŸ”‘ Database Pass:    ${YELLOW}$DB_PASSWORD${NC} (ÄÃ£ lÆ°u trong .env)"
    echo "--------------------------------------------------"
    echo "Äá»ƒ xem logs há»‡ thá»‘ng:"
    echo "  cd $INSTALL_DIR"
    echo "  docker compose -f $COMPOSE_FILE logs -f"
    echo "=================================================="
}

# --- MAIN FLOW ---
echo "=================================================="
echo "   ZERO TRUST INSTALLER - v1.0"
echo "=================================================="

check_environment
install_docker
setup_repository
configure_env
deploy_containers
show_summary
```

---

### HÆ°á»›ng dáº«n sá»­ dá»¥ng cho ngÆ°á»i dÃ¹ng cuá»‘i

Báº¡n chá»‰ cáº§n thÃªm dÃ²ng lá»‡nh nÃ y vÃ o `README.md` trÃªn Github. ÄÃ¢y lÃ  cÃ¡ch duy nháº¥t ngÆ°á»i dÃ¹ng cáº§n lÃ m:

```bash
curl -sSL https://raw.githubusercontent.com/maithanhduyan/zero-trust-netwoking/main/scripts/install.sh | sudo bash
```

### CÃ¡c bÆ°á»›c cáº§n lÃ m phÃ­a báº¡n (Developer):

1.  Táº¡o thÆ° má»¥c `scripts/` trong repo.
2.  LÆ°u Ä‘oáº¡n code trÃªn vÃ o file `scripts/install.sh`.
3.  Cáº¥p quyá»n thá»±c thi: `chmod +x scripts/install.sh`.
4.  Push lÃªn Github.

### Äiá»ƒm cáº£i tiáº¿n so vá»›i phiÃªn báº£n trÆ°á»›c:

- **Tá»± Ä‘á»™ng cáº­p nháº­t code:** Náº¿u ngÆ°á»i dÃ¹ng cháº¡y láº¡i script trÃªn má»™t server Ä‘Ã£ cÃ i rá»“i, script sáº½ tá»± Ä‘á»™ng thá»±c hiá»‡n `git fetch` vÃ  `git reset --hard` Ä‘á»ƒ cáº­p nháº­t code má»›i nháº¥t tá»« branch main mÃ  khÃ´ng lÃ m máº¥t file `.env`.
- **Kiá»ƒm tra file Compose:** Äáº£m báº£o file `docker-compose.prod.yml` tá»“n táº¡i trÆ°á»›c khi cháº¡y lá»‡nh `up`.
- **Clean Up:** Tá»± Ä‘á»™ng `docker compose down` phiÃªn báº£n cÅ© trÆ°á»›c khi cháº¡y báº£n má»›i Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t port hoáº·c cache.
