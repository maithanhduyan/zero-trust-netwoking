Dựa trên tài liệu **NIST Special Publication 800-207: Zero Trust Architecture** mà bạn cung cấp, dưới đây là bản tóm tắt và hướng dẫn thiết kế hệ thống **Zero Trust Networking (ZTA)**. Tài liệu này được cấu trúc để giúp các kiến trúc sư bảo mật và quản trị viên hệ thống hiểu và lên kế hoạch triển khai.

---

# TÀI LIỆU THIẾT KẾ KIẾN TRÚC ZERO TRUST (ZTA)
*(Dựa trên chuẩn NIST SP 800-207)*

## 1. Tổng quan và Định nghĩa
**Zero Trust (ZT)** không phải là một công nghệ đơn lẻ mà là một tập hợp các nguyên tắc an ninh mạng. Tư duy cốt lõi là chuyển dịch từ việc bảo vệ "biên mạng" (network perimeter) tĩnh sang tập trung bảo vệ **người dùng (users), tài sản (assets) và tài nguyên (resources)**.

*   **Nguyên lý căn bản:** "Không bao giờ tin tưởng, luôn luôn xác minh" (Never trust, always verify). Không có sự tin tưởng ngầm định (implicit trust) cho bất kỳ tài sản hay tài khoản người dùng nào chỉ dựa trên vị trí vật lý hoặc vị trí mạng (ví dụ: mạng LAN nội bộ hay Internet).

## 2. Bảy Nguyên tắc Cốt lõi của Zero Trust (The 7 Tenets)
Mọi thiết kế ZTA phải tuân thủ 7 nguyên tắc sau:

1.  **Tất cả dữ liệu và dịch vụ tính toán đều là TÀI NGUYÊN:** Bao gồm cả thiết bị cá nhân (BYOD), thiết bị IoT, và các dịch vụ đám mây (SaaS).
2.  **Bảo mật mọi giao tiếp bất kể vị trí mạng:** Truy cập từ mạng nội bộ cũng phải đáp ứng các tiêu chuẩn bảo mật khắt khe như truy cập từ bên ngoài (mã hóa, xác thực).
3.  **Truy cập tài nguyên được cấp theo từng PHIÊN (Per-session):** Sự tin tưởng được đánh giá lại trước mỗi kết nối. Việc xác thực vào mạng không đồng nghĩa với việc được quyền truy cập vào ứng dụng.
4.  **Truy cập được quyết định bởi CHÍNH SÁCH ĐỘNG (Dynamic Policy):** Quyết định cấp quyền dựa trên:
    *   Danh tính đối tượng (User ID).
    *   Trạng thái thiết bị (Device health/posture).
    *   Hành vi người dùng.
    *   Môi trường (Thời gian, vị trí địa lý).
5.  **Giám sát và đo lường trạng thái an ninh của mọi tài sản:** Không có thiết bị nào là tin cậy tuyệt đối. Hệ thống phải liên tục quét lỗ hổng và trạng thái bản vá (CDM).
6.  **Xác thực và ủy quyền liên tục:** Sử dụng Đa yếu tố xác thực (MFA) và kiểm tra lại liên tục trong suốt quá trình kết nối, không chỉ tại thời điểm đăng nhập.
7.  **Thu thập thông tin để cải thiện bảo mật:** Dùng dữ liệu mạng, log truy cập để phân tích và tối ưu hóa chính sách bảo mật.

## 3. Các Thành phần Logic trong Kiến trúc (Logical Components)

Hệ thống ZTA được chia làm hai phần: **Control Plane** (Mặt phẳng điều khiển) và **Data Plane** (Mặt phẳng dữ liệu).

### A. Core Components (Thành phần cốt lõi)
1.  **Policy Engine (PE - Bộ máy chính sách):** "Bộ não" của hệ thống. Chịu trách nhiệm ra quyết định (Cho phép/Từ chối) dựa trên chính sách và thuật toán tin cậy (Trust Algorithm).
2.  **Policy Administrator (PA - Quản trị chính sách):** Người thực thi quyết định của PE. PA sẽ ra lệnh tạo hoặc ngắt kết nối.
3.  **Policy Enforcement Point (PEP - Điểm thực thi chính sách):** Cổng kết nối (Gateway/Agent). Đây là nơi duy nhất luồng dữ liệu đi qua. PEP chặn mọi truy cập cho đến khi PA cho phép.

### B. Input Data Sources (Nguồn dữ liệu đầu vào cho PE)
Để PE ra quyết định chính xác, cần tích hợp dữ liệu từ:
*   **CDM System:** Trạng thái sức khỏe thiết bị.
*   **Threat Intelligence:** Thông tin về các mối đe dọa mới nhất.
*   **ID Management:** Hệ thống quản lý danh tính (LDAP, AD).
*   **SIEM:** Nhật ký hoạt động và sự kiện bảo mật.

## 4. Các Mô hình Triển khai Phổ biến (Deployment Variations)

Tùy thuộc vào hạ tầng hiện có, bạn có thể chọn một trong các mô hình sau:

1.  **Device Agent/Gateway-Based:**
    *   Cài đặt Agent trên thiết bị người dùng và Gateway trước tài nguyên.
    *   Phù hợp nhất cho doanh nghiệp kiểm soát chặt chẽ thiết bị (Enterprise-owned devices).
2.  **Enclave-Based:**
    *   Gateway đặt trước một nhóm tài nguyên (ví dụ: một trung tâm dữ liệu cũ - Legacy DC).
    *   Phù hợp cho các hệ thống cũ không hỗ trợ cài đặt Agent trực tiếp.
3.  **Resource Portal-Based:**
    *   Gateway đóng vai trò là một cổng web (Portal). Người dùng truy cập qua trình duyệt.
    *   Phù hợp cho BYOD hoặc đối tác bên ngoài (Contractors) mà không cần cài Agent.
4.  **Application Sandboxing:**
    *   Chạy ứng dụng trong các container/máy ảo cô lập trên thiết bị.

## 5. Thuật toán Tin cậy (Trust Algorithm)
Quyết định truy cập dựa trên công thức:
`Truy cập = f(Người dùng, Thiết bị, Ngữ cảnh, Mức độ nhạy cảm của dữ liệu)`

*   **Criteria-based:** Dựa trên tiêu chí cứng (Ví dụ: Phải thuộc nhóm Admin VÀ thiết bị đã update Windows mới nhất).
*   **Score-based:** Tính điểm tin cậy (Confidence Score). Nếu điểm > ngưỡng quy định -> Cho phép.

## 6. Lộ trình Chuyển đổi sang ZTA (Migration Roadmap)

Việc chuyển đổi không thể diễn ra trong một sớm một chiều. NIST đề xuất quy trình sau:

1.  **Xác định Đối tượng (Actors):** Ai là nhân viên, ai là đối tác, các tài khoản dịch vụ (non-person entities).
2.  **Xác định Tài sản (Assets):** Kiểm kê toàn bộ thiết bị và dữ liệu (Data classification).
3.  **Xác định Quy trình nghiệp vụ (Business Processes):** Chọn một quy trình ít rủi ro để thử nghiệm trước.
4.  **Xây dựng Chính sách (Formulating Policies):** Ai được truy cập cái gì, trong điều kiện nào? (Whitelist approach).
5.  **Lựa chọn Giải pháp (Identifying Solutions):** Chọn công nghệ phù hợp (SDP, Micro-segmentation, Identity-aware proxy...).
6.  **Triển khai ban đầu & Giám sát (Initial Deployment):** Chạy ở chế độ "Chỉ theo dõi" (Audit/Log only) để tinh chỉnh chính sách, tránh làm gián đoạn công việc.
7.  **Mở rộng (Expanding):** Áp dụng chế độ thực thi (Enforcement) và mở rộng sang các quy trình nghiệp vụ khác.

## 7. Các Mối đe dọa & Rủi ro
Khi triển khai ZTA, cần lưu ý:
*   **Tấn công vào Control Plane (PE/PA):** Nếu PE/PA bị chiếm quyền hoặc bị DDoS, toàn bộ hoạt động truy cập sẽ bị tê liệt. Cần bảo vệ kỹ lưỡng các thành phần này.
*   **Đánh cắp tài khoản (Stolen Credentials):** ZTA giảm thiểu rủi ro này bằng MFA và Trust Algorithm ngữ cảnh (ví dụ: phát hiện hành vi bất thường dù đúng mật khẩu), nhưng không loại bỏ hoàn toàn.
*   **Phụ thuộc vào nhà cung cấp (Vendor Lock-in):** Do thiếu các tiêu chuẩn giao tiếp chung giữa các thành phần ZT.

---
*Tài liệu này tóm tắt các điểm chính yếu từ NIST SP 800-207 để hỗ trợ việc thiết kế hệ thống bảo mật hiện đại.*
Dựa trên nguyên lý **NIST SP 800-207** và yêu cầu tự chủ (Self-hosted Custom WireGuard) mà bạn đã chọn, đây là cấu trúc thư mục chuẩn cho dự án `zero-trust-networking`.

Cấu trúc này được thiết kế theo mô hình **Monorepo** để dễ quản lý phiên bản đồng nhất giữa Control Plane (Server) và Agent (Client).

### Cấu trúc thư mục tổng quát

```text
zero-trust-networking/
├── control-plane/           # (NÃO BỘ) Server quản lý trung tâm
│   ├── api/                 # Interface giao tiếp với Agent và Admin
│   ├── core/                # Logic nghiệp vụ cốt lõi
│   ├── database/            # Lưu trữ trạng thái (Postgres/SQLite)
│   ├── policy-engine/       # (PDP) Nơi ra quyết định Trust Algorithm
│   └── web-ui/              # (Optional) Dashboard quản trị
│
├── agent/                   # (TAY CHÂN) Chạy trên từng VPS/Client
│   ├── core/                # Logic kết nối API, Heartbeat
│   ├── wireguard/           # Quản lý Interface WG, Key pair
│   └── firewall/            # (PEP) Quản lý iptables/nftables
│
├── policies/                # (LUẬT) Định nghĩa Policy-as-Code
│   ├── access-control/      # Ai được gặp ai (ACLs)
│   └── compliance/          # Yêu cầu về OS, version...
│
├── infrastructure/          # (CƠ BẮP) Automation & Deployment
│   ├── ansible/             # Playbooks cài đặt (như đã bàn ở trên)
│   ├── docker/              # Dockerfile cho Control Plane
│   └── scripts/             # Helper scripts (keygen, bootstrap)
│
├── docs/                    # Tài liệu kiến trúc & vận hành
├── tests/                   # E2E Testing
├── docker-compose.yml       # Dev environment
├── Makefile                 # Shortcuts lệnh
└── README.md
```

---

### Chi tiết từng thành phần (Deep Dive)

#### 1. `control-plane/` (Policy Administrator - PA)
Đây là nơi chứa API server. Nó **không** xử lý gói tin dữ liệu (Data Plane), nó chỉ phân phối cấu hình.

```text
control-plane/
├── main.py                  # Entrypoint (FastAPI/Go)
├── config.py                # Load biến môi trường
├── api/
│   ├── v1/
│   │   ├── endpoints.py     # /register, /sync, /heartbeat
│   │   └── admin.py         # API cho người quản trị
│   └── dependencies.py      # Auth middleware (mTLS/Token)
├── core/
│   ├── key_manager.py       # Quản lý Public Keys
│   └── ipam.py              # Cấp phát IP ảo (10.10.0.x)
├── database/
│   ├── models.py            # Node, Peer, Policy tables
│   └── migrations/          # Alembic/SQL migration scripts
└── policy-engine/           # QUAN TRỌNG NHẤT
    ├── evaluator.py         # Hàm tính điểm tin cậy (Trust Score)
    └── compiler.py          # Chuyển Policy -> WireGuard Config + IPTables
```

*   **Điểm nhấn:** Module `policy-engine` tách biệt. Khi API nhận request từ Agent, nó phải hỏi `policy-engine` trước khi trả về config.

#### 2. `agent/` (Policy Enforcement Point - PEP)
Chạy trên mỗi VPS (Odoo, Postgres, Ops). Nó phải cực nhẹ và ổn định.

```text
agent/
├── agent.py                 # Main loop (Scheduler)
├── client.py                # HTTP Client gọi về Control Plane (mTLS)
├── wireguard/
│   ├── manager.py           # Gọi lệnh `wg`, `wg-quick`
│   └── config_builder.py    # Tạo file wg0.conf từ JSON
├── firewall/
│   ├── iptables.py          # Wrapper lệnh iptables
│   └── nftables.py          # (Future proof)
└── collectors/              # Thu thập thông tin cho Trust Algorithm
    ├── host_info.py         # Lấy OS version, uptime
    └── network_stats.py     # Lấy thông tin traffic
```

*   **Điểm nhấn:** `firewall` module là nơi thực thi Zero Trust. Nếu Control Plane bảo "Cấm", module này sẽ `DROP` gói tin ngay tại máy, trước khi nó vào đến ứng dụng.

#### 3. `policies/` (Policy as Code)
Thay vì lưu cứng trong Database, policy nên được định nghĩa bằng code (YAML/JSON) để có thể Review và Version Control.

```text
policies/
├── global.yaml              # Policy mặc định (VD: Deny All)
├── roles/
│   ├── database.yaml        # Role: Postgres (Allow port 5432 from App)
│   ├── app.yaml             # Role: Odoo (Allow outbound to DB)
│   └── ops.yaml             # Role: Admin (Allow SSH)
└── users/
    └── admin-team.yaml      # Mapping user -> role
```

*   **Logic:** Control Plane sẽ đọc các file này khi khởi động hoặc khi có trigger reload để cập nhật vào Database/Memory.

#### 4. `infrastructure/` (Ansible & Deployment)
Nơi chứa code để triển khai hệ thống này ra 4 VPS thực tế.

```text
infrastructure/
├── ansible/
│   ├── inventory/
│   │   └── hosts.ini
│   ├── roles/
│   │   ├── common/          # Cài Python, Docker
│   │   ├── control-plane/   # Deploy Docker container Control Plane
│   │   └── agent/           # Cài Systemd service cho Agent
│   └── deploy-site.yml
└── docker/
    └── Dockerfile.control   # Image cho Control Plane
```

---

### Workflow hoạt động (Ví dụ)

1.  **Khởi tạo:**
    *   Bạn định nghĩa file `policies/roles/database.yaml`: *Chỉ cho phép `role:app` kết nối port `5432`*.
    *   Bạn chạy `ansible` để deploy Control Plane lên VPS-1 và Agent lên VPS-2 (App), VPS-3 (DB).

2.  **Đăng ký (Registration):**
    *   Agent tại VPS-3 (DB) khởi động, sinh Key, gọi API `/register` với thông tin `role: database`.
    *   Control Plane lưu thông tin, chưa cấp quyền ngay (Pending Approval).

3.  **Cấp phép (Trust Evaluation):**
    *   Bạn (Admin) approve node VPS-3.
    *   `policy-engine` tính toán: Node này là DB, vậy nó cần mở port 5432 cho ai? -> Cho `role: app`.

4.  **Đồng bộ (Synchronization):**
    *   Agent tại VPS-3 gọi `/sync`.
    *   Control Plane trả về:
        *   WireGuard Peer: VPS-1 (Hub), VPS-2 (App).
        *   Firewall Rule: `ALLOW TCP 5432 FROM 10.10.0.2 (VPS-2 IP)`.
    *   Agent tại VPS-3 apply config này.

Kết quả: **Zero Trust đạt được.** VPS-2 thấy VPS-3 qua tunnel, nhưng chỉ vào được port 5432. SSH (port 22) bị chặn bởi iptables do Agent quản lý (trừ khi policy cho phép).
---

Đây là script `install.sh` để khởi tạo cấu trúc dự án **Zero Trust Networking**.

Script này không chỉ tạo thư mục rỗng, mà còn **tự động sinh mã nguồn mẫu (boilerplate code)** cho API (FastAPI), Agent (Python), Policy (YAML) và Ansible để bạn có thể bắt đầu code logic ngay lập tức.

### Nội dung file `install.sh`

```bash
#!/bin/bash

# ==============================================================================
#  ZERO TRUST PROJECT SCAFFOLDING SCRIPT
#  ----------------------------------------------------------------------------
#  Mục tiêu: Khởi tạo cấu trúc Monorepo chuẩn NIST SP 800-207
#  Bao gồm: Control Plane (FastAPI), Agent, Policy-as-Code, Infrastructure
# ==============================================================================

set -e

# --- CẤU HÌNH ---
PROJECT_NAME="zero-trust-networking"
CURRENT_DIR=$(pwd)
TARGET_DIR="$CURRENT_DIR/$PROJECT_NAME"

# Màu sắc
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# --- HÀM HỖ TRỢ ---
log() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[DONE]${NC} $1"; }

create_file() {
    local path="$1"
    local content="$2"
    if [ ! -f "$path" ]; then
        echo "$content" > "$path"
    fi
}

# --- BẮT ĐẦU ---

if [ -d "$TARGET_DIR" ]; then
    echo "Thư mục $PROJECT_NAME đã tồn tại. Bạn có muốn tiếp tục? (y/n)"
    read -r response
    if [[ "$response" != "y" ]]; then exit 1; fi
fi

mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

log "1. Khởi tạo cấu trúc Control Plane (The Brain)..."
mkdir -p control-plane/{api/v1,core,database/migrations,policy-engine,tests}
touch control-plane/__init__.py

# Tạo file main.py mẫu cho Control Plane
create_file "control-plane/main.py" "from fastapi import FastAPI
from api.v1 import endpoints

app = FastAPI(title='Zero Trust Control Plane', version='1.0.0')

app.include_router(endpoints.router, prefix='/api/v1')

@app.get('/health')
def health_check():
    return {'status': 'active', 'component': 'control-plane'}"

# Tạo file endpoints mẫu
create_file "control-plane/api/v1/endpoints.py" "from fastapi import APIRouter

router = APIRouter()

@router.post('/register')
def register_node(node_data: dict):
    # TODO: Call Policy Engine here
    return {'status': 'pending_approval', 'node_id': 'tmp-123'}"

# Tạo file Policy Engine mẫu
create_file "control-plane/policy-engine/evaluator.py" "class TrustEvaluator:
    def evaluate(self, subject, resource, context):
        # NIST SP 800-207 Trust Algorithm
        score = 0
        # Logic tính điểm tin cậy
        return score >= 80"

create_file "control-plane/requirements.txt" "fastapi
uvicorn
sqlalchemy
alembic
pydantic
psycopg2-binary"

log "2. Khởi tạo cấu trúc Agent (The Muscles)..."
mkdir -p agent/{core,wireguard,firewall,collectors,tests}
touch agent/__init__.py

# Tạo file agent.py mẫu
create_file "agent/agent.py" "import time
import logging

class ZeroTrustAgent:
    def __init__(self):
        self.node_id = None
    
    def heartbeat(self):
        # Gửi thông tin về Control Plane
        pass

    def run(self):
        logging.info('Agent starting...')
        while True:
            self.heartbeat()
            time.sleep(60)

if __name__ == '__main__':
    ZeroTrustAgent().run()"

# Tạo module firewall mẫu
create_file "agent/firewall/iptables.py" "import subprocess

def apply_rule(src_ip, port, proto='tcp'):
    cmd = f'iptables -A INPUT -s {src_ip} -p {proto} --dport {port} -j ACCEPT'
    # subprocess.run(cmd, shell=True)"

create_file "agent/requirements.txt" "requests
schedule
psutil
netifaces"

log "3. Khởi tạo cấu trúc Policies (The Law)..."
mkdir -p policies/{roles,global,users}

# Tạo Policy mẫu cho Database
create_file "policies/roles/database.yaml" "kind: Role
metadata:
  name: postgres-primary
  tags:
    - tag:db
    - tag:prod
spec:
  inbound:
    - port: 5432
      protocol: tcp
      allow_from:
        - role: odoo-app
  compliance:
    os: ubuntu-22.04
    encryption: required"

# Tạo Policy mẫu cho App
create_file "policies/roles/app.yaml" "kind: Role
metadata:
  name: odoo-app
spec:
  outbound:
    - role: postgres-primary"

log "4. Khởi tạo Infrastructure (Automation)..."
mkdir -p infrastructure/ansible/{inventory,roles,playbooks}
mkdir -p infrastructure/docker
mkdir -p infrastructure/scripts

# Tạo Dockerfile cho Control Plane
create_file "infrastructure/docker/Dockerfile.control" "FROM python:3.10-slim
WORKDIR /app
COPY control-plane/requirements.txt .
RUN pip install -r requirements.txt
COPY control-plane .
CMD [\"uvicorn\", \"main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"]"

# Tạo Ansible Inventory mẫu
create_file "infrastructure/ansible/inventory/hosts.ini" "[control_plane]
vps-1

[agents]
vps-2
vps-3
vps-4"

log "5. Tạo các file cấu hình gốc..."
create_file "README.md" "# Zero Trust Networking Platform

## Architecture
- **Control Plane**: FastAPI (Decision Point)
- **Agent**: Python + WireGuard (Enforcement Point)
- **Policy**: YAML based

## Quick Start
1. Run \`make install\`
2. Run \`make up\`"

create_file "Makefile" "install:
	pip install -r control-plane/requirements.txt
	pip install -r agent/requirements.txt

up:
	docker-compose up -d

test:
	pytest"

# Tạo docker-compose để dev local
create_file "docker-compose.yml" "version: '3.8'
services:
  control-plane:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.control
    ports:
      - '8000:8000'
    volumes:
      - ./control-plane:/app
    environment:
      - DB_URL=postgresql://user:pass@db:5432/zt_db

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: zt_db"

success "Dự án đã được khởi tạo tại: $TARGET_DIR"
echo "--------------------------------------------------------"
echo "Bước tiếp theo:"
echo "1. cd $PROJECT_NAME"
echo "2. Khám phá cấu trúc thư mục"
echo "3. Bắt đầu code logic tại control-plane/policy-engine/"
echo "--------------------------------------------------------"
```

### Cách sử dụng

1.  Lưu đoạn mã trên vào file `install.sh`.
2.  Cấp quyền thực thi:
    ```bash
    chmod +x install.sh
    ```
3.  Chạy script tại thư mục bạn muốn chứa dự án:
    ```bash
    ./install.sh
    ```

### Kết quả bạn nhận được
Sau khi chạy, bạn sẽ có ngay một dự án **đủ tiêu chuẩn** để bắt đầu phát triển, không phải lo nghĩ về việc đặt file ở đâu.

*   **`control-plane/`**: Đã có sẵn FastAPI server chạy được ngay.
*   **`agent/`**: Đã có khung sườn cho Agent chạy ngầm.
*   **`policies/`**: Đã có ví dụ về Role-based policy (Odoo được gọi Postgres).
*   **`infrastructure/`**: Đã có Dockerfile và Ansible inventory.

Đây là **bộ khung "xương sống"** (Skeleton) vững chắc nhất để bạn xây dựng hệ thống Zero Trust tự chủ.